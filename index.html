<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>FlowCal</title>
  
  <!-- PWA Meta Tags -->
  <meta name="description" content="FlowCal. Budget calendar for tracking bills and cash flow.">
  <meta name="theme-color" content="#0a1628">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="FlowCal">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@700&display=swap" rel="stylesheet">
  
  <style>
    :root {
      /* FlowCal - Ocean Flow Theme */
      --bg-primary: #0a1628;
      --bg-secondary: #112240;
      --bg-tertiary: #1a3354;
      --border-color: #234876;
      --text-primary: #e6f1ff;
      --text-secondary: #8892b0;
      --text-muted: #5c6a86;
      --accent-flow: #00d9ff;
      --accent-green: #00c9a7;
      --accent-red: #ff6b6b;
      --accent-orange: #ffc145;
      --accent-purple: #bd93f9;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.5;
      padding-bottom: 70px;
    }

    /* Status/Error boxes */
    #statusBox {
      display: none;
      background: var(--bg-tertiary);
      border: 1px solid var(--accent-orange);
      padding: 10px;
      margin: 12px;
      border-radius: 8px;
      font-size: 12px;
    }
    #statusBox div { padding: 2px 0; }
    .status-ok { color: var(--accent-green); }
    .status-fail { color: var(--accent-red); }
    .status-wait { color: var(--accent-orange); }

    #errorBox {
      display: none;
      background: #2d1b1b;
      border: 2px solid var(--accent-red);
      color: var(--accent-red);
      padding: 12px;
      margin: 12px;
      border-radius: 8px;
      font-family: monospace;
      font-size: 11px;
      white-space: pre-wrap;
      word-break: break-all;
    }
    #errorBox.show { display: block; }

    /* Auth */
    #authSection {
      display: none;
      padding: 20px;
    }
    .auth-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 20px;
      max-width: 360px;
      margin: 0 auto;
    }
    .auth-title {
      font-weight: 700;
      font-size: 18px;
      margin-bottom: 16px;
      text-align: center;
    }

    /* Forms */
    input, select, button {
      font-family: inherit;
      font-size: 14px;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background: var(--bg-tertiary);
      color: var(--text-primary);
      width: 100%;
      margin-bottom: 10px;
    }
    input:focus, select:focus { outline: none; border-color: var(--accent-flow); }
    button {
      cursor: pointer;
      font-weight: 600;
      background: var(--accent-flow);
      border-color: var(--accent-flow);
    }
    button:active { opacity: 0.8; }
    .btn-row { display: flex; gap: 8px; }
    .btn-row button { flex: 1; }
    .btn-secondary { background: var(--bg-tertiary); border-color: var(--border-color); }
    .btn-danger { background: #3d1f1f; border-color: var(--accent-red); color: var(--accent-red); }

    .form-label {
      font-size: 11px;
      color: var(--text-secondary);
      margin-bottom: 4px;
      display: block;
      text-transform: uppercase;
    }

    #authMsg {
      margin-top: 10px;
      font-size: 13px;
      color: var(--text-secondary);
      text-align: center;
    }

    /* Main app */
    #mainApp { display: none; }

    /* Header bar - Option A layout */
    .header-bar {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      padding: 10px 16px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      gap: 0 16px;
    }
    .header-left {
      display: flex;
      align-items: center;
    }
    .header-today {
      font-size: 13px;
      color: var(--text-primary);
      font-weight: 500;
      cursor: pointer;
    }
    .header-today:hover {
      color: var(--accent-flow);
    }
    .header-today .today-label {
      color: var(--accent-orange);
      font-weight: 600;
    }
    
    .header-brand {
      font-family: 'Sora', sans-serif;
      font-size: 22px;
      font-weight: 700;
      letter-spacing: 1px;
      background: linear-gradient(90deg, var(--accent-flow) 0%, #00c9a7 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-align: center;
    }

    .header-right {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 10px;
    }
    .header-email {
      font-size: 13px;
      color: var(--text-primary);
      font-weight: 500;
    }
    .header-signout {
      color: var(--accent-orange);
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
    }
    .header-signout:hover {
      color: var(--accent-flow);
    }

    /* Compact KPI row */
    .kpi-row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border-color);
    }
    .kpi-box {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      font-size: 12px;
    }
    .kpi-label {
      color: var(--text-muted);
      text-transform: uppercase;
      font-size: 10px;
    }
    .kpi-value {
      font-weight: 600;
    }
    .kpi-box.flow .kpi-value { color: var(--accent-flow); }
    .kpi-box.green .kpi-value { color: var(--accent-green); }
    .kpi-box.red .kpi-value { color: var(--accent-red); }
    .kpi-separator {
      color: var(--text-muted);
      font-size: 14px;
    }

    /* Negative balance warning banner */
    .balance-warning {
      display: none;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      margin: 0 8px;
      background: rgba(255, 107, 107, 0.12);
      border: 1px solid rgba(255, 107, 107, 0.3);
      border-radius: 8px;
      font-size: 13px;
      color: var(--accent-red);
      cursor: pointer;
      transition: background 0.15s;
    }
    .balance-warning.visible { display: flex; }
    .balance-warning:hover { background: rgba(255, 107, 107, 0.2); }
    .balance-warning-icon { font-size: 16px; flex-shrink: 0; }
    .balance-warning-text { flex: 1; }
    .balance-warning-amount { font-weight: 700; white-space: nowrap; }

    /* Negative balance cell highlight (desktop) */
    .cal-cell.negative-balance {
      border-left: 3px solid var(--accent-red);
    }
    .cal-cell.today.negative-balance { border-left: 3px solid var(--accent-red); }

    /* Month nav */
    .month-nav {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 6px 12px;
      gap: 8px;
      border-bottom: 1px solid var(--border-color);
      position: relative;
    }
    .month-nav-center {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .month-nav button {
      width: auto;
      padding: 4px 10px;
      margin: 0;
      font-size: 14px;
      background: var(--bg-tertiary);
      border-color: var(--border-color);
    }
    .month-nav button:hover {
      border-color: var(--accent-flow);
    }
    .month-nav .recurring-link {
      position: absolute;
      right: 12px;
    }
    .balance-link {
      position: absolute;
      left: 12px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      width: auto;
      padding: 4px 10px;
      margin: 0;
      font-size: 11px;
      background: transparent;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-secondary);
      cursor: pointer;
    }
    .balance-link:hover {
      border-color: var(--accent-flow);
      color: var(--text-primary);
    }
    .balance-link-label {
      color: var(--text-muted);
    }
    .balance-link-value {
      font-weight: 600;
    }
    .balance-link-value.pos { color: var(--accent-green); }
    .balance-link-value.neg { color: var(--accent-red); }
    #monthLabel {
      font-weight: 700;
      font-size: 16px;
      min-width: 100px;
      text-align: center;
      color: var(--accent-flow);
    }

    /* Calendar grid */
    .cal-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 3px;
      padding: 0 8px 12px;
    }
    .cal-dow {
      text-align: center;
      font-size: 11px;
      color: var(--text-secondary);
      padding: 6px 2px;
      font-weight: 600;
    }
    .cal-cell {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      min-height: 100px;
      font-size: 9px;
      cursor: pointer;
      position: relative;
      transition: border-color 0.15s, background-color 0.15s;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .cal-cell:hover {
      border-color: var(--accent-flow);
      background: var(--bg-tertiary);
    }
    .cal-cell:active { background: var(--bg-tertiary); }
    .cal-cell.today { border-color: var(--accent-orange); border-width: 2px; }
    .cal-cell.today .cal-header { background: rgba(255, 193, 69, 0.15); }

    .cal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 6px;
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border-color);
    }
    .cal-header.pos { background: rgba(63, 185, 80, 0.15); }
    .cal-header.neg { background: rgba(248, 81, 73, 0.15); }
    .cal-day-num {
      font-weight: 700;
      font-size: 12px;
      position: relative;
    }
    .unpaid-dot {
      display: inline-block;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #ff6b6b; /* Coral red for needs attention */
      margin-left: 4px;
      vertical-align: middle;
    }
    .cal-bal {
      font-size: 10px;
      font-weight: 600;
    }
    .cal-bal.pos { color: var(--accent-green); }
    .cal-bal.neg { color: var(--accent-red); }

    .cal-body {
      flex: 1;
      padding: 3px 4px;
      overflow: hidden;
    }
    .cal-bill-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 10px;
      line-height: 1.3;
      gap: 4px;
    }
    .cal-bill-name {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: var(--text-primary);
    }
    .cal-bill-amt {
      white-space: nowrap;
      font-weight: 500;
    }
    .cal-bill-amt.in { color: var(--accent-green); }
    .cal-bill-amt.out { color: var(--accent-red); }
    .cal-more {
      font-size: 8px;
      color: var(--text-muted);
      text-align: center;
      padding-top: 2px;
    }

    /* ========== MOBILE VIEW STYLES ========== */
    
    /* Show/hide based on viewport */
    .mobile-only { display: none; }
    .desktop-only { display: block; }
    
    @media (max-width: 767px) {
      .mobile-only { display: block; }
      .desktop-only { display: none; }
      
      .header-bar {
        padding: 8px 12px;
        gap: 0;
      }
      .header-left {
        min-width: 0;
      }
      .header-today {
        font-size: 11px;
        color: var(--text-muted);
        white-space: nowrap;
      }
      .header-brand {
        font-size: 18px;
        border-left: 1px solid rgba(255, 255, 255, 0.12);
        border-right: 1px solid rgba(255, 255, 255, 0.12);
        padding: 0 14px;
        margin: 0 6px;
      }
      .header-right .header-email {
        display: none;
      }
      .header-signout {
        font-size: 10px;
      }
      .balance-link {
        font-size: 10px;
        padding: 3px 8px;
      }
      #monthLabel {
        font-size: 15px;
        min-width: 90px;
      }
      
      /* Compact KPIs for mobile - single row */
      .kpi-row {
        gap: 2px;
        padding: 6px 10px;
      }
      .month-nav .recurring-link {
        display: none;
      }
      .kpi-separator {
        font-size: 10px;
      }
      .kpi-box {
        gap: 3px;
        padding: 4px 2px;
        font-size: 11px;
        white-space: nowrap;
      }
      .kpi-label {
        font-size: 8px;
      }
      .kpi-value {
        font-size: 12px;
      }
      
      /* Mini Month Calendar */
      .mini-month {
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border-color);
        padding: 8px 12px;
      }
      .mini-month-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 2px;
        text-align: center;
      }
      .mini-dow {
        font-size: 10px;
        color: var(--text-muted);
        padding: 4px 0;
      }
      .mini-day {
        font-size: 12px;
        padding: 8px 2px;
        border-radius: 4px;
        cursor: pointer;
        position: relative;
        color: var(--text-secondary);
        border: 2px solid transparent;
      }
      .mini-day.empty {
        visibility: hidden;
      }
      .mini-day.today {
        background: var(--accent-orange);
        color: var(--bg-primary);
        font-weight: 700;
      }
      .mini-day.selected {
        border: 2px solid var(--accent-flow);
      }
      /* Paid status dots */
      .mini-day.has-bills::after {
        content: '';
        position: absolute;
        bottom: 2px;
        left: 50%;
        transform: translateX(-50%);
        width: 4px;
        height: 4px;
        border-radius: 50%;
        background: var(--accent-green);
      }
      .mini-day.has-unpaid::after {
        background: #ff6b6b; /* Coral red for needs attention */
      }
      .mini-day.has-bills.today::after,
      .mini-day.has-unpaid.today::after {
        background: var(--bg-primary);
      }
      /* Negative balance indicator on mini calendar */
      .mini-day.negative-bal {
        color: var(--accent-red);
        font-weight: 600;
      }
      .mini-day.negative-bal.today {
        background: var(--accent-red);
        color: var(--bg-primary);
      }
      
      /* Loading spinner for buttons */
      button.loading {
        position: relative;
        color: transparent !important;
        pointer-events: none;
      }
      button.loading::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 16px;
        height: 16px;
        margin: -8px 0 0 -8px;
        border: 2px solid var(--border-color);
        border-top-color: var(--accent-flow);
        border-radius: 50%;
        animation: spin 0.6s linear infinite;
      }
      
      .day-group {
        background: var(--bg-secondary);
        border-radius: 10px;
        margin-bottom: 8px;
        overflow: hidden;
        border: 1px solid var(--border-color);
      }
      
      .day-group-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 14px;
        background: var(--bg-tertiary);
        cursor: pointer;
        user-select: none;
      }
      .day-group-header:active {
        background: var(--border-color);
      }
      
      .day-group-left {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .day-group-date {
        font-weight: 600;
        font-size: 14px;
        color: var(--text-primary);
      }
      .day-group-count {
        font-size: 11px;
        color: var(--text-muted);
        background: var(--bg-secondary);
        padding: 2px 6px;
        border-radius: 10px;
      }
      
      .day-group-balance {
        font-weight: 600;
        font-size: 13px;
      }
      .day-group-balance.pos { color: var(--accent-green); }
      .day-group-balance.neg { color: var(--accent-red); }
      
      .day-group-bills {
        border-top: 1px solid var(--border-color);
      }
      .day-group.collapsed .day-group-bills {
        display: none;
      }
      
      .day-bill {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 14px;
        border-bottom: 1px solid var(--border-color);
      }
      .day-bill:last-child {
        border-bottom: none;
      }
      .day-bill:active {
        background: var(--bg-tertiary);
      }
      
      .day-bill-left {
        flex: 1;
        min-width: 0;
      }
      .day-bill-name {
        font-size: 14px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .day-bill-badge {
        font-size: 10px;
        color: var(--text-muted);
        margin-left: 4px;
      }
      .day-bill-badge.edited {
        color: var(--accent-orange);
      }
      
      .day-bill-right {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .day-bill-amount {
        font-weight: 600;
        font-size: 14px;
      }
      .day-bill-amount.in { color: var(--accent-green); }
      .day-bill-amount.out { color: var(--accent-red); }
      
      .day-bill-check {
        width: 22px;
        height: 22px;
      }
      
      .day-group-empty {
        padding: 16px 14px;
        text-align: center;
        color: var(--text-muted);
        font-size: 13px;
      }
      
      /* Single Day View */
      #singleDayView {
        display: none;
        padding: 8px;
        padding-bottom: 24px;
      }
      #singleDayView.active {
        display: block;
      }
      #dayListView {
        padding: 8px;
        padding-bottom: 24px;
      }
      #dayListView.hidden {
        display: none;
      }
      
      .day-view-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        padding: 0 4px;
      }
      .day-view-title {
        flex: 1;
        text-align: center;
        font-size: 16px;
        font-weight: 700;
        color: var(--text-primary);
      }
      .day-view-nav-btn {
        width: auto;
        padding: 6px 12px;
        margin: 0;
        font-size: 12px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        color: var(--accent-flow);
        flex-shrink: 0;
      }
      
      .single-day-card {
        background: var(--bg-secondary);
        border-radius: 12px;
        border: 1px solid var(--border-color);
        overflow: hidden;
      }
      
      .single-day-balance-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        background: var(--bg-tertiary);
        border-bottom: 1px solid var(--border-color);
      }
      .single-day-balance-label {
        font-size: 12px;
        color: var(--text-muted);
      }
      .single-day-balance {
        font-size: 16px;
        font-weight: 700;
      }
      .single-day-balance.pos { color: var(--accent-green); }
      .single-day-balance.neg { color: var(--accent-red); }
      
      .single-day-bills {
        min-height: 60px;
      }
      
      .single-day-empty {
        padding: 32px 16px;
        text-align: center;
        color: var(--text-muted);
        font-size: 14px;
      }
      
      .single-day-add {
        padding: 12px;
        border-top: 1px solid var(--border-color);
        background: var(--bg-secondary);
      }
      .single-day-add-row {
        display: flex;
        gap: 8px;
      }
      .single-day-add-row input[type="text"] {
        flex: 2;
        margin: 0;
      }
      .single-day-add-row input[type="number"] {
        flex: 1;
        margin: 0;
        min-width: 70px;
      }
      .single-day-add-row button {
        width: 48px;
        margin: 0;
        font-size: 18px;
        font-weight: 700;
      }
      
      /* List view back button */
      .list-view-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        padding: 0 4px;
      }
      .list-view-title {
        flex: 1;
        text-align: center;
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
      }
      .list-view-back-btn {
        width: auto;
        padding: 6px 12px;
        margin: 0;
        font-size: 12px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        color: var(--accent-flow);
        flex-shrink: 0;
      }
      
      /* Import Screenshot Button */
      .import-screenshot-btn {
        width: 100%;
        margin-top: 10px;
        padding: 10px;
        font-size: 13px;
        background: var(--bg-tertiary);
        border: 1px dashed var(--border-color);
        color: var(--accent-flow);
      }
      .import-screenshot-btn:active {
        background: var(--border-color);
      }
    }
    
    /* ========== END MOBILE VIEW STYLES ========== */
    
    /* Import Modal Styles (global) */
    .import-modal {
      max-height: 80vh;
      overflow-y: auto;
    }
    .import-hint {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 12px;
      line-height: 1.4;
    }
    .import-upload-btn {
      width: 100%;
      padding: 20px;
      font-size: 16px;
      background: var(--bg-tertiary);
      border: 2px dashed var(--border-color);
      color: var(--accent-flow);
      border-radius: 12px;
      cursor: pointer;
    }
    .import-upload-btn:hover {
      border-color: var(--accent-flow);
      background: var(--bg-secondary);
    }
    .import-preview-img {
      margin-top: 12px;
      text-align: center;
    }
    .import-preview-img img {
      max-width: 100%;
      max-height: 200px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }
    .import-error {
      color: var(--accent-red);
      font-size: 13px;
      margin-top: 8px;
      text-align: center;
    }
    .import-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 20px;
      color: var(--text-secondary);
    }
    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid var(--border-color);
      border-top-color: var(--accent-flow);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .import-transaction {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      margin-bottom: 6px;
    }
    .import-transaction input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin: 0;
    }
    .import-transaction-info {
      flex: 1;
      min-width: 0;
    }
    .import-transaction-name {
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .import-transaction-date {
      font-size: 11px;
      color: var(--text-muted);
    }
    .import-transaction-amount {
      font-weight: 600;
      font-size: 14px;
      white-space: nowrap;
    }
    .import-transaction-amount.in { color: var(--accent-green); }
    .import-transaction-amount.out { color: var(--accent-red); }
    
    .import-summary {
      margin-top: 12px;
      padding: 10px;
      background: var(--bg-secondary);
      border-radius: 8px;
      font-size: 13px;
      text-align: center;
      color: var(--text-secondary);
    }
    
    .import-success {
      text-align: center;
      padding: 20px;
    }
    .import-success-icon {
      display: inline-block;
      width: 50px;
      height: 50px;
      line-height: 50px;
      font-size: 28px;
      background: var(--accent-green);
      color: var(--bg-primary);
      border-radius: 50%;
      margin-bottom: 12px;
    }
    .import-success p {
      font-size: 16px;
      color: var(--text-primary);
    }

    /* Desktop: taller cells, larger text */
    @media (min-width: 768px) {
      .cal-cell {
        min-height: 160px;
      }
      .cal-header { padding: 5px 8px; }
      .cal-day-num { font-size: 14px; }
      .cal-bal { font-size: 12px; }
      .cal-body { padding: 4px 6px; }
      .cal-bill-row { font-size: 12px; }
      .cal-more { font-size: 11px; }
      .cal-grid { gap: 6px; padding: 0 16px 16px; }
      .kpi-box { font-size: 14px; }
      .kpi-label { font-size: 11px; }
      .kpi-value { font-size: 15px; }
      #monthLabel { font-size: 18px; min-width: 130px; }
      .header-today { font-size: 14px; }
    }

    /* Large screens: even taller cells */
    @media (min-width: 1200px) {
      .cal-cell {
        min-height: 180px;
      }
      .cal-bill-row { font-size: 13px; }
    }

    /* Clickable KPIs */
    .kpi-box.clickable {
      cursor: pointer;
      transition: border-color 0.15s, background-color 0.15s;
      border: 1px solid transparent;
    }
    .kpi-box.clickable:hover {
      border-color: var(--accent-flow);
      background: var(--bg-tertiary);
    }

    /* Filter modal bill list */
    .filter-bill-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      margin-bottom: 6px;
      font-size: 14px;
    }
    .filter-bill-date {
      color: var(--text-secondary);
      font-size: 12px;
      min-width: 55px;
      font-family: monospace;
    }
    .filter-bill-name {
      flex: 1;
      margin: 0 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .filter-bill-amt {
      font-weight: 600;
      white-space: nowrap;
    }
    .filter-bill-amt.in { color: var(--accent-green); }
    .filter-bill-amt.out { color: var(--accent-red); }

    /* Recurring button */
    .recurring-link {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      width: auto;
      padding: 4px 10px;
      margin: 0;
      font-size: 11px;
      background: transparent;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-secondary);
      cursor: pointer;
    }
    .recurring-link:hover {
      border-color: var(--accent-flow);
      color: var(--text-primary);
    }
    .recurring-link-label {
      font-weight: 600;
    }
    .recurring-link-label.pos { color: var(--accent-green); }
    .recurring-link-label.neg { color: var(--accent-red); }
    .recurring-link-icon {
      color: var(--text-muted);
    }

    /* Balance sheet modal */
    .bal-sheet-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      font-size: 14px;
    }
    .bal-sheet-section {
      font-size: 13px;
      font-weight: 700;
      color: var(--text-secondary);
      padding: 10px 12px 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .bal-sheet-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 12px 6px 24px;
      font-size: 13px;
    }
    .bal-sheet-item-name {
      flex: 1;
      min-width: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: var(--text-secondary);
    }
    .bal-sheet-item-date {
      color: var(--text-muted);
      font-size: 11px;
      font-family: monospace;
      min-width: 50px;
      margin-right: 10px;
    }
    .bal-sheet-item-amt {
      font-weight: 500;
      white-space: nowrap;
    }
    .bal-sheet-divider {
      border-top: 1px solid var(--border-color);
      margin: 4px 12px;
    }
    .bal-sheet-total {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 12px;
      font-weight: 700;
      font-size: 14px;
    }
    .bal-sheet-highlight {
      background: var(--bg-tertiary);
      border-radius: 8px;
      margin: 4px 0;
      padding: 10px 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 700;
      font-size: 15px;
    }
    
    /* Reconcile modal */
    .reconcile-input-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 12px 0;
    }
    .reconcile-input-row label {
      font-size: 13px;
      color: var(--text-secondary);
      white-space: nowrap;
    }
    .reconcile-input-row input {
      flex: 1;
      padding: 8px 10px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 15px;
      font-family: inherit;
    }
    .reconcile-result {
      background: var(--bg-tertiary);
      border-radius: 8px;
      padding: 12px;
      margin: 12px 0;
    }
    .reconcile-result-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 0;
      font-size: 14px;
    }
    .reconcile-result-row.highlight {
      font-weight: 700;
      font-size: 15px;
      padding: 8px 0 4px;
      border-top: 1px solid var(--border-color);
      margin-top: 6px;
    }
    .reconcile-section-title {
      font-size: 13px;
      font-weight: 700;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 14px 0 6px;
    }
    .reconcile-match {
      background: var(--bg-tertiary);
      border-radius: 8px;
      padding: 10px 12px;
      margin: 8px 0;
      border-left: 3px solid var(--accent-orange);
    }
    .reconcile-match-header {
      font-size: 12px;
      color: var(--accent-orange);
      font-weight: 600;
      margin-bottom: 6px;
    }
    .reconcile-match-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 0;
      font-size: 13px;
    }
    .reconcile-match-item .item-detail {
      flex: 1;
      min-width: 0;
    }
    .reconcile-match-item .item-name {
      color: var(--text-primary);
    }
    .reconcile-match-item .item-meta {
      color: var(--text-muted);
      font-size: 11px;
    }
    .reconcile-match-item .item-amt {
      font-weight: 500;
      white-space: nowrap;
      margin: 0 10px;
    }
    .reconcile-match-actions {
      display: flex;
      gap: 6px;
      margin-top: 8px;
      padding-top: 6px;
      border-top: 1px solid var(--border-color);
    }
    .reconcile-match-actions button {
      flex: 1;
      padding: 6px 8px;
      font-size: 12px;
      border-radius: 6px;
      cursor: pointer;
      border: none;
    }
    .btn-keep {
      background: var(--bg-secondary);
      color: var(--text-secondary);
      border: 1px solid var(--border-color) !important;
    }
    .btn-delete-dup {
      background: rgba(255,107,107,0.15);
      color: var(--accent-red);
    }
    .reconcile-ok {
      text-align: center;
      padding: 16px;
      color: var(--accent-green);
      font-size: 15px;
      font-weight: 600;
    }
    .reconcile-ok .check-icon {
      font-size: 32px;
      display: block;
      margin-bottom: 6px;
    }
    .reconcile-diff-match {
      background: var(--bg-tertiary);
      border-radius: 8px;
      padding: 10px 12px;
      margin: 6px 0;
      border-left: 3px solid var(--accent-flow);
    }
    .reconcile-diff-match .match-explanation {
      font-size: 12px;
      color: var(--accent-flow);
      font-weight: 600;
      margin-bottom: 6px;
    }
    .reconcile-diff-match .match-entry {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      padding: 2px 0;
    }
    .reconcile-diff-match .match-entry .entry-name {
      color: var(--text-primary);
    }
    .reconcile-diff-match .match-entry .entry-meta {
      color: var(--text-muted);
      font-size: 11px;
    }
    .reconcile-diff-match .match-entry .entry-amt {
      font-weight: 500;
      white-space: nowrap;
    }
    .reconcile-pairs-toggle {
      background: none;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      color: var(--accent-flow);
      font-size: 12px;
      padding: 6px 12px;
      cursor: pointer;
      display: block;
      margin: 8px auto 0;
      font-family: inherit;
    }
    .reconcile-pairs-toggle:hover {
      background: var(--bg-tertiary);
    }

    /* Rules slideout modal */
    .rules-slideout {
      position: fixed;
      top: 0;
      right: -100%;
      width: 100%;
      max-width: 480px;
      height: 100%;
      background: var(--bg-primary);
      z-index: 200;
      transition: right 0.3s ease;
      display: flex;
      flex-direction: column;
    }
    .rules-slideout.open {
      right: 0;
    }
    .rules-slideout-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      border-bottom: 1px solid var(--border-color);
      background: var(--bg-secondary);
    }
    .rules-slideout-header h2 {
      font-size: 18px;
      margin: 0;
    }
    .rules-slideout-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 24px;
      cursor: pointer;
      padding: 4px 8px;
      line-height: 1;
      width: auto;
      margin: 0;
    }
    .rules-slideout-body {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }
    .rules-slideout-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 199;
      display: none;
    }
    .rules-slideout-overlay.open {
      display: block;
    }
    
    /* Inline rule editing */
    .rule-item {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      margin-bottom: 8px;
      overflow: hidden;
      transition: all 0.2s ease;
    }
    .rule-item.editing {
      border-color: var(--accent-flow);
    }
    .rule-item.inactive .rule-summary { opacity: 0.5; }
    .rule-summary {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      cursor: pointer;
    }
    .rule-summary:hover {
      background: var(--bg-tertiary);
    }
    .rule-info { flex: 1; min-width: 0; }
    .rule-name {
      font-weight: 600;
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .rule-detail {
      font-size: 11px;
      color: var(--text-secondary);
    }
    .rule-amt {
      font-weight: 700;
      font-size: 14px;
      white-space: nowrap;
    }
    .rule-amt.in { color: var(--accent-green); }
    .rule-amt.out { color: var(--accent-red); }
    .rule-edit-form {
      display: none;
      padding: 12px;
      background: var(--bg-tertiary);
      border-top: 1px solid var(--border-color);
    }
    .rule-item.editing .rule-edit-form {
      display: block;
    }
    .rule-edit-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }
    .rule-edit-row input,
    .rule-edit-row select {
      margin: 0;
      width: auto;
      flex: 1;
    }
    .rule-edit-row input[type="number"] {
      max-width: 100px;
    }
    .rule-edit-row select {
      max-width: 120px;
    }
    .rule-edit-actions {
      display: flex;
      gap: 8px;
      justify-content: space-between;
      margin-top: 12px;
    }
    .rule-edit-actions .left-btns {
      display: flex;
      gap: 8px;
    }
    .rule-edit-actions button {
      margin: 0;
      padding: 8px 12px;
      font-size: 12px;
    }

    /* Frequency badge */
    .freq-badge {
      font-size: 10px;
      color: var(--accent-purple);
      font-weight: 600;
    }
    /* Estimated amount (crossed out when actual differs) */
    .est-amount {
      text-decoration: line-through;
      opacity: 0.5;
      font-size: 0.9em;
      margin-right: 4px;
    }
    /* Form hint text */
    .form-hint {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
      line-height: 1.4;
    }
    /* Date input styling in rule edit */
    .rule-edit-row input[type="date"] {
      max-width: 160px;
    }

    .rules-list {
      padding: 0;
    }
    input[type="checkbox"] {
      width: 22px;
      height: 22px;
      margin: 0;
      flex-shrink: 0;
    }

    /* Modals */
    .modal-bg {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
      padding: 16px;
    }
    .modal-bg.open { display: flex; }
    .modal-box {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      width: 100%;
      max-width: 450px;
      max-height: 85vh;
      overflow-y: auto;
      padding: 20px;
      position: relative;
    }
    .modal-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 16px;
      text-align: center;
    }
    
    /* Modal loading overlay */
    .modal-loading-overlay {
      display: none;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(10, 22, 40, 0.92);
      border-radius: 12px;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
      z-index: 10;
    }
    .modal-loading-overlay.active {
      display: flex;
    }
    .modal-loading-spinner {
      width: 36px;
      height: 36px;
      border: 3px solid var(--border-color);
      border-top-color: var(--accent-flow);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
    }
    .modal-loading-text {
      font-size: 14px;
      color: var(--text-secondary);
      font-weight: 500;
    }

    /* Day modal */
    .day-bill-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      margin-bottom: 8px;
    }
    .day-bill-info {
      flex: 1;
      min-width: 0;
      cursor: pointer;
    }
    .day-bill-name {
      font-weight: 600;
      font-size: 14px;
      display: block;
    }
    .day-bill-name .recurring-badge {
      font-size: 9px;
      color: var(--accent-purple);
      font-weight: 400;
    }
    .day-bill-amt {
      font-weight: 700;
      font-size: 14px;
      white-space: nowrap;
    }
    .day-bill-amt.in { color: var(--accent-green); }
    .day-bill-amt.out { color: var(--accent-red); }
    
    /* Pending bill styling */
    .day-bill-item.pending-bill {
      opacity: 0.85;
      border-left: 3px solid var(--accent-flow);
    }
    .day-bill-item.pending-bill .pending-delete {
      background: transparent;
      border: none;
      color: var(--accent-red);
      font-size: 18px;
      cursor: pointer;
      padding: 0 4px;
      line-height: 1;
      width: auto;
      margin: 0;
    }
    
    /* Inline delete button for saved bills */
    .day-bill-delete {
      width: 28px;
      height: 28px;
      min-width: 28px;
      padding: 0;
      margin: 0 0 0 6px;
      background: transparent;
      border: 1px solid var(--border-color);
      color: var(--text-muted);
      font-size: 18px;
      line-height: 1;
      cursor: pointer;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .day-bill-delete:hover {
      background: #3d1f1f;
      border-color: var(--accent-red);
      color: var(--accent-red);
    }
    
    /* Marked for deletion state */
    .day-bill-item.marked-for-delete {
      opacity: 0.5;
      background: #2d1f1f;
      border-left: 3px solid var(--accent-red);
    }
    .day-bill-item.marked-for-delete .day-bill-name {
      text-decoration: line-through;
      color: var(--text-muted);
    }
    .day-bill-item.marked-for-delete .day-bill-amt {
      text-decoration: line-through;
      opacity: 0.6;
    }
    .day-bill-item.marked-for-delete .day-bill-delete {
      background: var(--accent-red);
      border-color: var(--accent-red);
      color: var(--bg-primary);
    }
    .day-bill-item.marked-for-delete .day-bill-delete:hover {
      background: var(--accent-green);
      border-color: var(--accent-green);
    }

    /* Mark All Paid button in day modal */
    .mark-all-paid-btn {
      display: block;
      width: 100%;
      padding: 8px 12px;
      margin: 8px 0 4px;
      background: transparent;
      border: 1px dashed var(--accent-green);
      color: var(--accent-green);
      font-size: 13px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.15s, border-style 0.15s;
    }
    .mark-all-paid-btn:hover {
      background: rgba(0, 201, 167, 0.1);
      border-style: solid;
    }

    .quick-add-section {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border-color);
    }
    .quick-add-row {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .quick-add-row input {
      margin: 0;
      width: auto;
    }
    .quick-add-row input[type="text"] { flex: 2; min-width: 100px; }
    .quick-add-row input[type="number"] { flex: 1; min-width: 80px; max-width: 120px; }
    .quick-add-row button { flex-shrink: 0; width: auto; margin: 0; }

    /* Edit choice modal */
    .choice-btn {
      padding: 16px;
      margin-bottom: 10px;
      text-align: left;
    }
    .choice-btn strong { display: block; margin-bottom: 4px; }
    .choice-btn span { font-size: 12px; color: var(--text-secondary); font-weight: 400; }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }
  </style>
</head>
<body>

  <div id="statusBox">
    <div id="stat1" class="status-wait">1. Page loaded: checking...</div>
    <div id="stat2" class="status-wait">2. Supabase CDN: waiting...</div>
    <div id="stat3" class="status-wait">3. Supabase client: waiting...</div>
    <div id="stat4" class="status-wait">4. Auth check: waiting...</div>
  </div>

  <div id="errorBox"></div>

  <!-- Auth -->
  <div id="authSection">
    <div class="auth-card">
      <div class="auth-title">Sign In</div>
      <input type="email" id="authEmail" placeholder="Email">
      <input type="password" id="authPassword" placeholder="Password">
      <div class="btn-row">
        <button onclick="doSignIn()">Sign In</button>
        <button class="btn-secondary" onclick="doSignUp()">Sign Up</button>
      </div>
      <button class="btn-secondary" onclick="doMagicLink()">Send Magic Link</button>
      <div id="authMsg"></div>
    </div>
  </div>

  <!-- Main App -->
  <div id="mainApp">
    <!-- Header Bar -->
    <div class="header-bar">
      <div class="header-left">
        <span class="header-today" id="todayDate" onclick="goToToday()">Today: -</span>
      </div>
      <span class="header-brand">FlowCal</span>
      <div class="header-right">
        <span class="header-email" id="userEmail">-</span>
        <span class="header-signout" onclick="doSignOut()">Sign Out</span>
      </div>
    </div>

    <!-- Compact KPI Row -->
    <div class="kpi-row">
      <div class="kpi-box flow kpi-start">
        <span class="kpi-label">Start</span>
        <span class="kpi-value" id="kpiStart">$0</span>
      </div>
      <span class="kpi-separator">‚Üí</span>
      <div class="kpi-box red clickable kpi-out" onclick="showFilteredBills('OUT')">
        <span class="kpi-label">Out</span>
        <span class="kpi-value" id="kpiOut">$0</span>
      </div>
      <span class="kpi-separator">|</span>
      <div class="kpi-box green clickable kpi-in" onclick="showFilteredBills('IN')">
        <span class="kpi-label">In</span>
        <span class="kpi-value" id="kpiIn">$0</span>
      </div>
      <span class="kpi-separator">‚Üí</span>
      <div class="kpi-box flow kpi-end">
        <span class="kpi-label">End</span>
        <span class="kpi-value" id="kpiEnd">$0</span>
      </div>
    </div>

    <!-- Month Navigation -->
    <div class="month-nav">
      <button class="balance-link" id="monthBalBtn" onclick="showBalanceSheet()">
        <span class="balance-link-label">Bal:</span>
        <span class="balance-link-value" id="monthBalValue">$0</span>
      </button>
      <div class="month-nav-center">
        <button onclick="goPrev()">‚Üê</button>
        <span id="monthLabel">-</span>
        <button onclick="goNext()">‚Üí</button>
      </div>
      <button class="recurring-link" onclick="openRulesPanel()">
        <span class="recurring-link-label" id="recurringLabel">Recurring</span>
        <span class="recurring-link-icon">‚Üª</span>
      </button>
    </div>

    <!-- Negative Balance Warning -->
    <div class="balance-warning" id="balanceWarning" onclick="goToNegativeDay()">
      <span class="balance-warning-icon">‚ö†Ô∏è</span>
      <span class="balance-warning-text" id="balanceWarningText">Balance goes negative</span>
      <span class="balance-warning-amount" id="balanceWarningAmount">-$0</span>
    </div>

    <!-- Calendar View (no longer tabbed) -->
    <div id="calendarContent">
      <!-- Desktop: Grid View -->
      <div id="calContainer" class="desktop-only"></div>
      
      <!-- Mobile: List View -->
      <div id="mobileView" class="mobile-only">
        <!-- Mini Month -->
        <div class="mini-month">
          <div class="mini-month-grid">
            <span class="mini-dow">S</span>
            <span class="mini-dow">M</span>
            <span class="mini-dow">T</span>
            <span class="mini-dow">W</span>
            <span class="mini-dow">T</span>
            <span class="mini-dow">F</span>
            <span class="mini-dow">S</span>
          </div>
          <div class="mini-month-grid" id="miniMonthDays"></div>
        </div>
        
        <!-- Single Day View (default) -->
        <div id="singleDayView" class="active">
          <div class="day-view-header">
            <button class="day-view-nav-btn" onclick="showListView()">All Days</button>
            <span class="day-view-title" id="singleDayTitle">Today</span>
            <button class="day-view-nav-btn" onclick="openRulesPanel()">‚Üª Recurring</button>
          </div>
          <div class="single-day-card">
            <div class="single-day-balance-row">
              <span class="single-day-balance-label">End of Day Balance:</span>
              <span class="single-day-balance" id="singleDayBalance">$0</span>
            </div>
            <div class="single-day-bills" id="singleDayBills"></div>
            <div class="single-day-add">
              <div class="single-day-add-row">
                <input type="text" id="singleDayAddName" placeholder="Bill name" onkeypress="handleQuickAddKey(event, 'mobile')">
                <input type="number" id="singleDayAddAmt" step="0.01" placeholder="+/-" onkeypress="handleQuickAddKey(event, 'mobile')">
                <button id="singleDayAddBtn" onclick="singleDayQuickAdd()">+</button>
              </div>
              <button class="import-screenshot-btn" onclick="openImportModal()">üì∑ Import from Screenshot</button>
            </div>
          </div>
        </div>
        
        <!-- Day List View -->
        <div id="dayListView" class="hidden"></div>
      </div>
    </div>
  </div>

  <!-- Rules Slideout Panel -->
  <div class="rules-slideout-overlay" id="rulesOverlay" onclick="closeRulesPanel()"></div>
  <div class="rules-slideout" id="rulesPanel">
    <div class="rules-slideout-header">
      <h2>Recurring Bills</h2>
      <button class="rules-slideout-close" onclick="closeRulesPanel()">√ó</button>
    </div>
    <div class="rules-slideout-body">
      <div id="addRuleSection">
        <button id="addRuleBtn" onclick="toggleAddRuleInline()" style="width:100%;">+ Add Recurring Bill</button>
        <div class="rule-edit-form" id="addRuleForm" style="display:none;margin-bottom:12px;border-radius:8px;">
          <div class="rule-edit-row">
            <input type="text" id="newRuleName" placeholder="Name (e.g., Rent)">
          </div>
          <div class="rule-edit-row">
            <input type="number" id="newRuleAmt" step="0.01" placeholder="Amount">
            <select id="newRuleDir">
              <option value="OUT">Expense</option>
              <option value="IN">Income</option>
            </select>
          </div>
          <div class="rule-edit-row">
            <select id="newRuleFreq" onchange="toggleNewRuleFreqFields()">
              <option value="MONTHLY">Monthly</option>
              <option value="BIWEEKLY">Bi-weekly</option>
            </select>
            <input type="number" id="newRuleDay" min="1" max="31" placeholder="Day (1-31)">
            <input type="date" id="newRuleAnchor" style="display:none" placeholder="Known pay date">
          </div>
          <div class="rule-edit-row">
            <label style="display:flex;align-items:center;gap:6px;font-size:13px;color:#8aa;cursor:pointer;user-select:none;">
              <input type="checkbox" id="newRuleWeekendAdj"> Weekend ‚Üí preceding Friday
            </label>
          </div>
          <div class="rule-edit-actions">
            <div></div>
            <div class="left-btns">
              <button class="btn-secondary" onclick="cancelAddRuleInline()">Cancel</button>
              <button onclick="saveNewRuleInline()">Save</button>
            </div>
          </div>
        </div>
      </div>
      <div class="rules-list" id="rulesList"></div>
    </div>
  </div>

  <!-- Day Modal -->
  <div class="modal-bg" id="dayModal" onclick="handleDayModalBgClick(event)">
    <div class="modal-box" onclick="event.stopPropagation()">
      <div class="modal-title" id="dayModalTitle">-</div>
      <div id="dayBillsList"></div>
      <div class="quick-add-section">
        <div class="form-label">Quick Add</div>
        <div class="quick-add-row">
          <input type="text" id="dayAddName" placeholder="Name" onkeypress="handleQuickAddKey(event, 'desktop')">
          <input type="number" id="dayAddAmt" step="0.01" placeholder="+/-" onkeypress="handleQuickAddKey(event, 'desktop')">
          <button id="dayAddBtn" onclick="quickAddDay()">Add</button>
        </div>
        <div id="pendingCount" style="font-size:11px;color:var(--accent-flow);margin-top:6px;display:none;"></div>
        <div class="btn-row" style="margin-top:12px;">
          <button class="btn-secondary" onclick="cancelDayModal()">Cancel</button>
          <button id="daySaveBtn" onclick="saveDayModal()">Save & Close</button>
        </div>
      </div>
      <!-- Loading overlay -->
      <div class="modal-loading-overlay" id="dayModalLoading">
        <div class="modal-loading-spinner"></div>
        <div class="modal-loading-text">Saving...</div>
      </div>
    </div>
  </div>

  <!-- Edit Choice Modal (for recurring) -->
  <div class="modal-bg" id="editChoiceModal">
    <div class="modal-box">
      <div class="modal-title">Edit Recurring Bill</div>
      <div id="editChoiceName" style="text-align:center;margin-bottom:16px;color:var(--text-secondary);"></div>
      <button class="choice-btn btn-secondary" onclick="editThisOne()">
        <strong>Edit This One</strong>
        <span>Change only this month's instance</span>
      </button>
      <button class="choice-btn btn-secondary" onclick="editAllFuture()">
        <strong>Edit All Future</strong>
        <span>Change the recurring rule</span>
      </button>
      <button class="btn-secondary" onclick="closeEditChoiceModal()" style="margin-top:8px;">Cancel</button>
    </div>
  </div>

  <!-- Bill Edit Modal (manual or detached) -->
  <div class="modal-bg" id="billEditModal">
    <div class="modal-box">
      <div class="modal-title" id="billEditTitle">Edit Bill</div>
      <input type="hidden" id="billEditId">
      <label class="form-label">Name</label>
      <input type="text" id="billEditName">
      <label class="form-label">Amount</label>
      <input type="number" id="billEditAmt" step="0.01">
      <label class="form-label">Type</label>
      <select id="billEditDir">
        <option value="OUT">Expense (OUT)</option>
        <option value="IN">Income (IN)</option>
      </select>
      <label class="form-label">Due Date</label>
      <input type="date" id="billEditDue">
      <div class="btn-row">
        <button class="btn-secondary" onclick="closeBillEditModal()">Cancel</button>
        <button onclick="saveBillEdit()">Save</button>
      </div>
      <button class="btn-danger" onclick="deleteBillEdit()" style="margin-top:10px;">Delete</button>
    </div>
  </div>

  <!-- Rule Modal -->
  <div class="modal-bg" id="ruleModal">
    <div class="modal-box">
      <div class="modal-title" id="ruleModalTitle">Add Rule</div>
      <input type="hidden" id="ruleMode" value="add">
      <input type="hidden" id="ruleId">
      <label class="form-label">Name</label>
      <input type="text" id="ruleName" placeholder="e.g., Rent">
      <label class="form-label">Estimated Amount</label>
      <input type="number" id="ruleAmt" step="0.01" placeholder="0.00">
      <label class="form-label">Type</label>
      <select id="ruleDir">
        <option value="OUT">Expense (OUT)</option>
        <option value="IN">Income (IN)</option>
      </select>
      <label class="form-label">Frequency</label>
      <select id="ruleFreq" onchange="toggleModalFreqFields()">
        <option value="MONTHLY">Monthly</option>
        <option value="BIWEEKLY">Bi-weekly (every 2 weeks)</option>
      </select>
      <div id="monthlyFields">
        <label class="form-label">Due Day (1-31)</label>
        <input type="number" id="ruleDay" min="1" max="31" placeholder="15">
      </div>
      <div id="biweeklyFields" style="display:none">
        <label class="form-label">Anchor Date (any known pay date)</label>
        <input type="date" id="ruleAnchor">
        <div class="form-hint">Pick any date this bill/pay has occurred. Future dates will be calculated every 14 days from this anchor.</div>
      </div>
      <label class="form-label">Active</label>
      <select id="ruleActive">
        <option value="1">Yes</option>
        <option value="0">No</option>
      </select>
      <div class="btn-row">
        <button class="btn-secondary" onclick="closeRuleModal()">Cancel</button>
        <button onclick="saveRule()">Save</button>
      </div>
      <button id="ruleDelBtn" class="btn-danger" style="margin-top:10px;display:none;" onclick="deleteRule()">Delete Rule</button>
    </div>
  </div>

  <!-- Filtered Bills Modal (IN/OUT) -->
  <div class="modal-bg" id="filterModal">
    <div class="modal-box">
      <div class="modal-title" id="filterModalTitle">Bills</div>
      <div id="filterBillsList"></div>
      <div class="btn-row" style="margin-top:12px;">
        <button class="btn-secondary" onclick="closeFilterModal()">Close</button>
        <button onclick="copyFilteredBills()">Copy to Clipboard</button>
      </div>
      <div id="copyMsg" style="text-align:center;font-size:12px;color:var(--accent-green);margin-top:8px;display:none;">Copied!</div>
    </div>
  </div>

  <!-- Balance Sheet Modal -->
  <div class="modal-bg" id="balanceSheetModal">
    <div class="modal-box">
      <div class="modal-title" id="balanceSheetTitle">Balance Sheet</div>
      <div id="balanceSheetContent"></div>
      <div class="btn-row" style="margin-top:12px;">
        <button class="btn-secondary" onclick="closeBalanceSheet()">Close</button>
        <button onclick="openReconcile()">Reconcile</button>
        <button onclick="copyBalanceSheet()">Copy to Clipboard</button>
      </div>
      <div id="balCopyMsg" style="text-align:center;font-size:12px;color:var(--accent-green);margin-top:8px;display:none;">Copied!</div>
    </div>
  </div>

  <!-- Reconcile Modal -->
  <div class="modal-bg" id="reconcileModal">
    <div class="modal-box" style="max-width:440px;">
      <div class="modal-title">Reconcile ‚Äî <span id="reconcileMonthLabel"></span></div>
      <div id="reconcileContent"></div>
      <div class="btn-row" style="margin-top:12px;">
        <button class="btn-secondary" onclick="closeReconcile()">Close</button>
      </div>
    </div>
  </div>

  <!-- Import from Screenshot Modal -->
  <div class="modal-bg" id="importModal">
    <div class="modal-box import-modal">
      <div class="modal-title">Import from Screenshot</div>
      
      <!-- Step 1: Upload -->
      <div id="importStep1">
        <p class="import-hint">Take a screenshot of your bank transactions and upload it here. Claude will extract the transactions automatically.</p>
        <input type="file" id="importFileInput" accept="image/*" onchange="handleImportFile(event)" style="display:none;">
        <button class="import-upload-btn" onclick="$('importFileInput').click()">
          üì∑ Select or Take Photo
        </button>
        <div id="importPreviewImg" class="import-preview-img"></div>
        <div id="importError" class="import-error"></div>
        <div id="importLoading" class="import-loading" style="display:none;">
          <div class="spinner"></div>
          <span>Analyzing image...</span>
        </div>
      </div>
      
      <!-- Step 2: Review -->
      <div id="importStep2" style="display:none;">
        <p class="import-hint">Review the extracted transactions. Uncheck any you don't want to import.</p>
        <div id="importTransactionsList"></div>
        <div id="importSummary" class="import-summary"></div>
      </div>
      
      <!-- Step 3: Success -->
      <div id="importStep3" style="display:none;">
        <div class="import-success">
          <span class="import-success-icon">‚úì</span>
          <p>Successfully imported <span id="importedCount">0</span> transactions!</p>
        </div>
      </div>
      
      <div class="btn-row" style="margin-top:12px;">
        <button class="btn-secondary" onclick="closeImportModal()">Cancel</button>
        <button id="importConfirmBtn" onclick="confirmImport()" style="display:none;">Import Selected</button>
        <button id="importDoneBtn" onclick="closeImportModal()" style="display:none;">Done</button>
      </div>
    </div>
  </div>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <script>
    // ========== CONFIG ==========
    var SUPA_URL = 'https://ytjrcjrmiyvnvtigyjns.supabase.co';
    var SUPA_KEY = 'sb_publishable_vfoGwqibBfkq1iec8cm7xg_9xm5_WSw';
    var API_URL = SUPA_URL + '/functions/v1/bills';

    // ========== GLOBALS ==========
    var sb = null;
    var session = null;
    var state = {
      month: null,
      accountId: null,
      startBal: 0,
      instances: [],
      totals: null,
      rules: []
    };
    var currentDay = null;
    var selectedBill = null;
    var pendingDayBills = []; // Queue for batch quick add
    var pendingDeleteBills = []; // Queue for batch delete {id, hasRule}
    var isSavingDayModal = false; // Block interactions during save
    var editingRuleId = null; // Track which rule is being edited inline
    var firstNegativeDay = null; // First day balance goes negative (for warning click)

    // ========== HELPERS ==========
    function $(id) { return document.getElementById(id); }

    function showError(msg) {
      var box = $('errorBox');
      box.textContent = msg;
      box.classList.add('show');
    }

    function setStat(n, msg, ok) {
      var el = $('stat' + n);
      if (!el) return;
      el.textContent = n + '. ' + msg;
      el.className = ok ? 'status-ok' : (ok === false ? 'status-fail' : 'status-wait');
      if (ok === false) $('statusBox').style.display = 'block';
    }

    function money(n) {
      var num = Number(n) || 0;
      var sign = num < 0 ? '-' : '';
      return sign + '$' + Math.abs(num).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function esc(s) {
      var d = document.createElement('div');
      d.textContent = s || '';
      return d.innerHTML;
    }

    function isPaid(b) {
      return b.is_paid === true || b.is_paid === 1 || b.is_paid === 't' || b.is_paid === 'true';
    }

    function effectiveAmount(b) {
      if (isPaid(b) && b.paid_amount != null) return Number(b.paid_amount);
      return Number(b.amount || 0);
    }

    function addMonths(ms, delta) {
      var d = new Date(ms + 'T00:00:00Z');
      d.setUTCMonth(d.getUTCMonth() + delta);
      return d.toISOString().slice(0, 10);
    }

    function fmtMonth(ms) {
      var d = new Date(ms + 'T00:00:00Z');
      return d.toLocaleDateString('en-US', { month: 'short', year: 'numeric', timeZone: 'UTC' });
    }

    function daysIn(y, m) { return new Date(Date.UTC(y, m + 1, 0)).getUTCDate(); }
    function dow1(y, m) { return new Date(Date.UTC(y, m, 1)).getUTCDay(); }
    function isoD(y, m, d) {
      return y + '-' + String(m + 1).padStart(2, '0') + '-' + String(d).padStart(2, '0');
    }

    function todayISO() {
      var d = new Date();
      return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
    }

    // ========== RULES PANEL ==========
    function openRulesPanel() {
      $('rulesOverlay').classList.add('open');
      $('rulesPanel').classList.add('open');
      renderRules();
    }
    
    function closeRulesPanel() {
      $('rulesOverlay').classList.remove('open');
      $('rulesPanel').classList.remove('open');
      editingRuleId = null; // Clear any inline editing
    }

    // ========== API ==========
    function api(fn, args) {
      return new Promise(function(resolve, reject) {
        if (!session) { reject(new Error('Not signed in')); return; }

        fetch(API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + session.access_token,
            'apikey': SUPA_KEY
          },
          body: JSON.stringify({ fn: fn, args: args || {} })
        })
        .then(function(r) { return r.text(); })
        .then(function(txt) {
          var data;
          try { data = JSON.parse(txt); }
          catch (e) { reject(new Error('Bad JSON: ' + txt.slice(0, 100))); return; }
          if (data && data.error) {
            reject(new Error(data.error + (data.detail ? ': ' + data.detail : '')));
            return;
          }
          resolve(data);
        })
        .catch(reject);
      });
    }

    // ========== AUTH ==========
    function showAuth() {
      $('authSection').style.display = 'block';
      $('mainApp').style.display = 'none';
    }

    function showMain() {
      $('authSection').style.display = 'none';
      $('mainApp').style.display = 'block';
      $('userEmail').textContent = session.user.email || '-';
    }

    function doSignIn() {
      var email = $('authEmail').value.trim();
      var pw = $('authPassword').value;
      if (!email || !pw) { $('authMsg').textContent = 'Enter email and password'; return; }
      $('authMsg').textContent = 'Signing in...';

      sb.auth.signInWithPassword({ email: email, password: pw })
        .then(function(res) {
          if (res.error) { $('authMsg').textContent = 'Error: ' + res.error.message; return; }
          session = res.data.session;
          $('authMsg').textContent = '';
          showMain();
          loadBoot();
        })
        .catch(function(e) { $('authMsg').textContent = 'Error: ' + e.message; });
    }

    function doSignUp() {
      var email = $('authEmail').value.trim();
      var pw = $('authPassword').value;
      if (!email || !pw) { $('authMsg').textContent = 'Enter email and password'; return; }
      $('authMsg').textContent = 'Creating account...';

      sb.auth.signUp({ email: email, password: pw })
        .then(function(res) {
          if (res.error) { $('authMsg').textContent = 'Error: ' + res.error.message; return; }
          $('authMsg').textContent = 'Account created! Check email if confirmation required.';
        })
        .catch(function(e) { $('authMsg').textContent = 'Error: ' + e.message; });
    }

    function doMagicLink() {
      var email = $('authEmail').value.trim();
      if (!email) { $('authMsg').textContent = 'Enter email'; return; }
      $('authMsg').textContent = 'Sending link...';

      sb.auth.signInWithOtp({
        email: email,
        options: { emailRedirectTo: location.origin + location.pathname }
      })
        .then(function(res) {
          if (res.error) { $('authMsg').textContent = 'Error: ' + res.error.message; return; }
          $('authMsg').textContent = 'Check your email!';
        })
        .catch(function(e) { $('authMsg').textContent = 'Error: ' + e.message; });
    }

    function doSignOut() {
      sb.auth.signOut().then(function() { session = null; showAuth(); });
    }

    // ========== DATA ==========
    function loadBoot() {
      api('api_budgetBootstrap', {})
        .then(function(d) {
          state.month = d.month;
          state.accountId = d.accountDefaultId;
          state.startBal = Number(d.startingBalance || 0);
          state.instances = (d.bills && d.bills.instances) || [];
          state.totals = (d.bills && d.bills.totals) || null;
          render();
          loadRules();
        })
        .catch(function(e) { showError('Load failed: ' + e.message); });
    }

    function loadMonth(m) {
      api('api_loadBillMonth', { month: m, accountId: state.accountId })
        .then(function(d) {
          state.month = d.month;
          state.startBal = Number(d.startingBalance || 0);
          state.instances = d.instances || [];
          state.totals = d.totals || null;
          // Reset to day view when changing months
          selectedMobileDay = null;
          mobileViewMode = 'day';
          if ($('dayListView')) $('dayListView').classList.add('hidden');
          if ($('singleDayView')) $('singleDayView').classList.add('active');
          render();
        })
        .catch(function(e) { showError('Load month failed: ' + e.message); });
    }

    function loadRules() {
      api('api_listBillRules', { accountId: state.accountId, includeInactive: true })
        .then(function(d) {
          state.rules = d.rules || [];
          renderRules();
        })
        .catch(function(e) { /* silent */ });
    }

    // ========== RENDER ==========
    function render() {
      renderKPIs();
      renderMonthLabel();
      renderCal();
    }

    function renderKPIs() {
      var t = state.totals || {};
      var inT = Number(t.in_total || 0);
      var outT = Number(t.out_total || 0);
      var endB = state.startBal + inT - outT;

      $('kpiStart').textContent = money(state.startBal);
      $('kpiOut').textContent = money(outT);
      $('kpiIn').textContent = money(inT);
      $('kpiEnd').textContent = money(endB);

      // Compute actual current balance (only paid items)
      var paidIn = 0, paidOut = 0;
      (state.instances || []).forEach(function(b) {
        if (!isPaid(b)) return;
        var amt = effectiveAmount(b);
        if (b.direction === 'IN') paidIn += amt;
        else paidOut += amt;
      });
      var actualBal = state.startBal + paidIn - paidOut;

      // Update balance in month-nav (actual current balance)
      var balValEl = $('monthBalValue');
      balValEl.textContent = money(actualBal);
      var balCls = actualBal >= 0 ? 'pos' : 'neg';
      balValEl.className = 'balance-link-value ' + balCls;

      // Mirror recurring label color to match balance
      $('recurringLabel').className = 'recurring-link-label ' + balCls;

      // Today info in user bar
      var today = todayISO();
      var todayDate = new Date();
      var options = { weekday: 'short', month: 'short', day: 'numeric' };
      $('todayDate').innerHTML = '<span class="today-label">Today:</span> ' + todayDate.toLocaleDateString('en-US', options);

      // Negative balance warning
      var parts = state.month.split('-');
      var wy = parseInt(parts[0], 10);
      var wm = parseInt(parts[1], 10) - 1;
      var wNumD = daysIn(wy, wm);
      var wBal = state.startBal;
      var byDayW = {};
      (state.instances || []).forEach(function(b) {
        if (!b.due_date) return;
        var k = b.due_date.slice(0, 10);
        if (!byDayW[k]) byDayW[k] = [];
        byDayW[k].push(b);
      });
      firstNegativeDay = null;
      var lowestBal = Infinity;
      var lowestDay = null;
      for (var wd = 1; wd <= wNumD; wd++) {
        var wdk = isoD(wy, wm, wd);
        (byDayW[wdk] || []).forEach(function(b) {
          var a = effectiveAmount(b);
          wBal += b.direction === 'IN' ? a : -a;
        });
        if (wBal < 0 && !firstNegativeDay) firstNegativeDay = wdk;
        if (wBal < lowestBal) { lowestBal = wBal; lowestDay = wdk; }
      }
      var warnEl = $('balanceWarning');
      if (firstNegativeDay) {
        var negDate = new Date(firstNegativeDay + 'T12:00:00');
        var negDay = negDate.getDate();
        var negMon = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][negDate.getMonth()];
        $('balanceWarningText').textContent = 'Balance goes negative on ' + negMon + ' ' + negDay;
        $('balanceWarningAmount').textContent = money(lowestBal);
        warnEl.classList.add('visible');
      } else {
        warnEl.classList.remove('visible');
      }
    }

    function renderMonthLabel() {
      $('monthLabel').textContent = fmtMonth(state.month);
    }

    function renderCal() {
      var c = $('calContainer');
      var parts = state.month.split('-');
      var y = parseInt(parts[0], 10);
      var mIdx = parseInt(parts[1], 10) - 1;
      var numD = daysIn(y, mIdx);
      var firstDow = dow1(y, mIdx);
      var today = todayISO();

      var byDay = {};
      var unpaidByDay = {};
      (state.instances || []).forEach(function(b) {
        if (!b.due_date) return;
        var k = b.due_date.slice(0, 10);
        if (!byDay[k]) byDay[k] = [];
        byDay[k].push(b);
        // Check unpaid status
        var billPaid = isPaid(b);
        if (!billPaid) {
          unpaidByDay[k] = true;
        }
      });

      var runBal = state.startBal;
      var balByDay = {};
      for (var d = 1; d <= numD; d++) {
        var dk = isoD(y, mIdx, d);
        (byDay[dk] || []).forEach(function(b) {
          var a = effectiveAmount(b);
          runBal += b.direction === 'IN' ? a : -a;
        });
        balByDay[dk] = runBal;
      }

      var html = '<div class="cal-grid">';
      ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'].forEach(function(x) {
        html += '<div class="cal-dow">' + x + '</div>';
      });
      for (var e = 0; e < firstDow; e++) {
        html += '<div></div>';
      }
      for (var day = 1; day <= numD; day++) {
        var dateK = isoD(y, mIdx, day);
        var items = byDay[dateK] || [];
        var bal = balByDay[dateK];
        var balCls = bal >= 0 ? 'pos' : 'neg';
        var isToday = dateK === today;
        // Only show unpaid indicator for past dates (not future)
        var hasUnpaid = unpaidByDay[dateK] && dateK <= today;

        var cellClasses = 'cal-cell';
        if (isToday) cellClasses += ' today';
        if (hasUnpaid) cellClasses += ' has-unpaid';
        if (bal < 0) cellClasses += ' negative-balance';
        
        html += '<div class="' + cellClasses + '" onclick="openDay(\'' + dateK + '\')">';
        
        // Header with day number and balance
        html += '<div class="cal-header ' + balCls + '">';
        html += '<span class="cal-day-num">' + day + (hasUnpaid ? '<span class="unpaid-dot"></span>' : '') + '</span>';
        html += '<span class="cal-bal ' + balCls + '">' + money(bal) + '</span>';
        html += '</div>';
        
        // Body with bill rows
        html += '<div class="cal-body">';
        var maxShow = 5;
        for (var i = 0; i < Math.min(items.length, maxShow); i++) {
          var it = items[i];
          var sign = it.direction === 'IN' ? '+' : '-';
          var amtCls = it.direction === 'IN' ? 'in' : 'out';
          var amt = effectiveAmount(it).toFixed(2);
          html += '<div class="cal-bill-row">';
          html += '<span class="cal-bill-name">' + esc(it.name) + '</span>';
          html += '<span class="cal-bill-amt ' + amtCls + '">' + sign + '$' + amt + '</span>';
          html += '</div>';
        }
        if (items.length > maxShow) {
          html += '<div class="cal-more">+' + (items.length - maxShow) + ' more</div>';
        }
        html += '</div>';
        
        html += '</div>';
      }
      html += '</div>';
      c.innerHTML = html;
      
      // Also render mobile view
      renderMobileView();
    }

    // ========== MOBILE VIEW RENDERING ==========
    var selectedMobileDay = null;
    var mobileViewMode = 'day'; // 'day' or 'list'
    
    function renderMobileView() {
      // Default selected day to today
      if (!selectedMobileDay) {
        selectedMobileDay = todayISO();
      }
      renderMiniMonth();
      if (mobileViewMode === 'day') {
        renderSingleDay();
      } else {
        renderDayList();
      }
    }
    
    function showListView() {
      mobileViewMode = 'list';
      $('singleDayView').classList.remove('active');
      $('dayListView').classList.remove('hidden');
      renderDayList();
    }
    
    function showDayView(dateK) {
      if (dateK) selectedMobileDay = dateK;
      mobileViewMode = 'day';
      $('dayListView').classList.add('hidden');
      $('singleDayView').classList.add('active');
      renderMiniMonth();
      renderSingleDay();
    }
    
    function renderMiniMonth() {
      var container = $('miniMonthDays');
      if (!container) return;
      
      var parts = state.month.split('-');
      var y = parseInt(parts[0], 10);
      var mIdx = parseInt(parts[1], 10) - 1;
      var numD = daysIn(y, mIdx);
      var firstDow = dow1(y, mIdx);
      var today = todayISO();
      
      // Build map of days: { dateKey: { hasBills: true, hasUnpaid: true/false } }
      var dayStatus = {};
      var byDayMini = {};
      (state.instances || []).forEach(function(b) {
        if (b.due_date) {
          var dk = b.due_date.slice(0, 10);
          if (!dayStatus[dk]) {
            dayStatus[dk] = { hasBills: true, hasUnpaid: false };
          }
          if (!byDayMini[dk]) byDayMini[dk] = [];
          byDayMini[dk].push(b);
          // Check if unpaid (handle various boolean formats)
          var billPaid = isPaid(b);
          if (!billPaid) {
            dayStatus[dk].hasUnpaid = true;
          }
        }
      });
      
      // Calculate per-day running balance for negative indicators
      var miniRunBal = state.startBal;
      var miniBalByDay = {};
      for (var bd = 1; bd <= numD; bd++) {
        var bdk = isoD(y, mIdx, bd);
        (byDayMini[bdk] || []).forEach(function(b) {
          var a = effectiveAmount(b);
          miniRunBal += b.direction === 'IN' ? a : -a;
        });
        miniBalByDay[bdk] = miniRunBal;
      }
      
      // Set default selected day to today if in current month, otherwise 1st
      if (!selectedMobileDay || !selectedMobileDay.startsWith(state.month.slice(0, 7))) {
        var todayParts = today.split('-');
        if (todayParts[0] + '-' + todayParts[1] === parts[0] + '-' + parts[1].padStart(2, '0')) {
          selectedMobileDay = today;
        } else {
          selectedMobileDay = isoD(y, mIdx, 1);
        }
      }
      
      var html = '';
      // Empty cells for days before 1st
      for (var e = 0; e < firstDow; e++) {
        html += '<span class="mini-day empty"></span>';
      }
      // Day cells
      for (var d = 1; d <= numD; d++) {
        var dk = isoD(y, mIdx, d);
        var classes = ['mini-day'];
        if (dk === today) classes.push('today');
        if (dk === selectedMobileDay) classes.push('selected');
        if (dayStatus[dk]) {
          classes.push('has-bills');
          // Only show unpaid indicator for past dates (not future)
          if (dayStatus[dk].hasUnpaid && dk <= today) {
            classes.push('has-unpaid');
          }
        }
        if (miniBalByDay[dk] !== undefined && miniBalByDay[dk] < 0) {
          classes.push('negative-bal');
        }
        html += '<span class="' + classes.join(' ') + '" onclick="selectMobileDay(\'' + dk + '\')">' + d + '</span>';
      }
      
      container.innerHTML = html;
    }
    
    function renderDayList() {
      var container = $('dayListView');
      if (!container) return;
      
      var parts = state.month.split('-');
      var y = parseInt(parts[0], 10);
      var mIdx = parseInt(parts[1], 10) - 1;
      var numD = daysIn(y, mIdx);
      var today = todayISO();
      
      // Group bills by day
      var byDay = {};
      (state.instances || []).forEach(function(b) {
        if (!b.due_date) return;
        var k = b.due_date.slice(0, 10);
        if (!byDay[k]) byDay[k] = [];
        byDay[k].push(b);
      });
      
      // Calculate running balance per day
      var runBal = state.startBal;
      var balByDay = {};
      for (var d = 1; d <= numD; d++) {
        var dk = isoD(y, mIdx, d);
        (byDay[dk] || []).forEach(function(b) {
          var a = effectiveAmount(b);
          runBal += b.direction === 'IN' ? a : -a;
        });
        balByDay[dk] = runBal;
      }
      
      // Header with back button
      var html = '<div class="list-view-header">';
      html += '<button class="list-view-back-btn" onclick="showDayView()">‚Üê Day View</button>';
      html += '<span class="list-view-title">All Days</span>';
      html += '<button class="day-view-nav-btn" onclick="openRulesPanel()">‚Üª Recurring</button>';
      html += '</div>';
      
      var dowNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      var hasContent = false;
      
      for (var day = 1; day <= numD; day++) {
        var dateK = isoD(y, mIdx, day);
        var items = byDay[dateK] || [];
        var bal = balByDay[dateK];
        var balCls = bal >= 0 ? 'pos' : 'neg';
        var isToday = dateK === today;
        var dayOfWeek = new Date(y, mIdx, day).getDay();
        
        // Only show days with bills or today
        if (items.length === 0 && !isToday) continue;
        hasContent = true;
        
        // Expanded by default if has bills
        var isExpanded = items.length > 0;
        
        html += '<div class="day-group' + (isExpanded ? '' : ' collapsed') + '" id="dayGroup-' + dateK + '">';
        
        // Header - tap to collapse/expand
        html += '<div class="day-group-header" onclick="toggleDayGroup(\'' + dateK + '\')">';
        html += '<div class="day-group-left">';
        html += '<span class="day-group-date">' + (isToday ? 'Today' : dowNames[dayOfWeek]) + ', ' + (mIdx + 1) + '/' + day + '</span>';
        if (items.length > 0) {
          html += '<span class="day-group-count">' + items.length + ' bill' + (items.length > 1 ? 's' : '') + '</span>';
        }
        html += '</div>';
        html += '<span class="day-group-balance ' + balCls + '">' + money(bal) + '</span>';
        html += '</div>';
        
        // Bills section
        html += '<div class="day-group-bills">';
        if (items.length === 0) {
          html += '<div class="day-group-empty">No bills</div>';
        } else {
          items.forEach(function(b) {
            var isIn = b.direction === 'IN';
            var amtCls = isIn ? 'in' : 'out';
            var sign = isIn ? '+' : '-';
            var isRecurring = !!b.bill_rule_id && !b.is_manual;
            var isEdited = !!b.bill_rule_id && b.is_manual;
            var badge = isRecurring ? '<span class="day-bill-badge">(recurring)</span>' : 
                        isEdited ? '<span class="day-bill-badge edited">(edited)</span>' : '';
            
            html += '<div class="day-bill" onclick="editBill(\'' + b.id + '\')">';
            html += '<div class="day-bill-left">';
            html += '<span class="day-bill-name">' + esc(b.name) + badge + '</span>';
            html += '</div>';
            html += '<div class="day-bill-right">';
            html += '<span class="day-bill-amount ' + amtCls + '">' + sign + money(effectiveAmount(b)) + '</span>';
            html += '<input type="checkbox" class="day-bill-check" ' + (b.is_paid ? 'checked' : '') + ' onclick="event.stopPropagation();togglePaid(\'' + b.id + '\', this.checked, ' + Number(b.amount || 0) + ', ' + (!!b.bill_rule_id) + ')">';
            html += '</div>';
            html += '</div>';
          });
        }
        html += '</div>';
        html += '</div>';
      }
      
      if (!hasContent) {
        html += '<div class="day-group-empty" style="padding:32px;">No bills this month.<br>Tap a day in the calendar to add one.</div>';
      }
      
      container.innerHTML = html;
    }
    
    function renderSingleDay() {
      if (!selectedMobileDay) return;
      
      var parts = state.month.split('-');
      var y = parseInt(parts[0], 10);
      var mIdx = parseInt(parts[1], 10) - 1;
      var numD = daysIn(y, mIdx);
      var today = todayISO();
      
      // Group bills by day
      var byDay = {};
      (state.instances || []).forEach(function(b) {
        if (!b.due_date) return;
        var k = b.due_date.slice(0, 10);
        if (!byDay[k]) byDay[k] = [];
        byDay[k].push(b);
      });
      
      // Calculate running balance up to selected day
      var runBal = state.startBal;
      for (var d = 1; d <= numD; d++) {
        var dk = isoD(y, mIdx, d);
        (byDay[dk] || []).forEach(function(b) {
          var a = effectiveAmount(b);
          runBal += b.direction === 'IN' ? a : -a;
        });
        if (dk === selectedMobileDay) break;
      }
      
      var items = byDay[selectedMobileDay] || [];
      var dayDate = new Date(selectedMobileDay + 'T12:00:00');
      var dowNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      var monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      
      var isToday = selectedMobileDay === today;
      var titleText = isToday ? 'Today' : dowNames[dayDate.getDay()];
      titleText += ', ' + monthNames[dayDate.getMonth()] + ' ' + dayDate.getDate();
      
      $('singleDayTitle').textContent = titleText;
      var balEl = $('singleDayBalance');
      balEl.textContent = money(runBal);
      balEl.className = 'single-day-balance ' + (runBal >= 0 ? 'pos' : 'neg');
      
      var billsContainer = $('singleDayBills');
      var html = '';
      
      if (items.length === 0) {
        html = '<div class="single-day-empty">No bills on this day</div>';
      } else {
        items.forEach(function(b) {
          var isIn = b.direction === 'IN';
          var amtCls = isIn ? 'in' : 'out';
          var sign = isIn ? '+' : '-';
          var isRecurring = !!b.bill_rule_id && !b.is_manual;
          var isEdited = !!b.bill_rule_id && b.is_manual;
          var badge = isRecurring ? '<span class="day-bill-badge">(recurring)</span>' : 
                      isEdited ? '<span class="day-bill-badge edited">(edited)</span>' : '';
          
          html += '<div class="day-bill" onclick="editBill(\'' + b.id + '\')">';
          html += '<div class="day-bill-left">';
          html += '<span class="day-bill-name">' + esc(b.name) + badge + '</span>';
          html += '</div>';
          html += '<div class="day-bill-right">';
          html += '<span class="day-bill-amount ' + amtCls + '">' + sign + money(effectiveAmount(b)) + '</span>';
          html += '<input type="checkbox" class="day-bill-check" ' + (b.is_paid ? 'checked' : '') + ' onclick="event.stopPropagation();togglePaid(\'' + b.id + '\', this.checked, ' + Number(b.amount || 0) + ', ' + (!!b.bill_rule_id) + ')">';
          html += '</div>';
          html += '</div>';
        });
      }
      
      billsContainer.innerHTML = html;
    }
    
    function selectMobileDay(dateK) {
      showDayView(dateK);
    }
    
    function toggleDayGroup(dateK) {
      var el = $('dayGroup-' + dateK);
      if (el) {
        el.classList.toggle('collapsed');
      }
    }
    
    function singleDayQuickAdd() {
      var nameEl = $('singleDayAddName');
      var amtEl = $('singleDayAddAmt');
      var btn = $('singleDayAddBtn');
      var name = nameEl.value.trim();
      var amtRaw = amtEl.value.trim();
      
      if (!name) {
        alert('Enter a bill name');
        return;
      }
      
      var amt = parseFloat(amtRaw) || 0;
      if (amt === 0) {
        alert('Enter an amount');
        return;
      }
      
      var dir = amt < 0 ? 'OUT' : 'IN';
      amt = Math.abs(amt);
      
      var dueDate = selectedMobileDay || todayISO();
      
      // Show loading
      btn.classList.add('loading');
      
      api('api_createManualBill', {
        accountId: state.accountId,
        billMonth: state.month,
        dueDate: dueDate,
        name: name,
        amount: amt,
        direction: dir
      })
        .then(function() {
          nameEl.value = '';
          amtEl.value = '';
          nameEl.focus(); // Focus back to name for rapid entry
          refreshAfterEdit();
        })
        .catch(function(e) {
          alert('Error: ' + e.message);
        })
        .finally(function() {
          btn.classList.remove('loading');
        });
    }
    
    // Handle Enter key for quick add inputs
    function handleQuickAddKey(event, mode) {
      if (event.key === 'Enter') {
        event.preventDefault();
        if (mode === 'mobile') {
          singleDayQuickAdd();
        } else {
          quickAddDay();
        }
      }
    }

    function renderRules() {
      var list = state.rules || [];
      var c = $('rulesList');

      if (list.length === 0) {
        c.innerHTML = '<div class="empty-state">No recurring bills yet.<br>Add one to auto-generate monthly bills.</div>';
        return;
      }

      var html = '';
      list.forEach(function(r) {
        var isIn = r.direction === 'IN';
        var amtCls = isIn ? 'in' : 'out';
        var sign = isIn ? '+' : '-';
        var inactive = !r.active;
        var isEditing = editingRuleId === r.id;
        var isBiweekly = r.frequency === 'BIWEEKLY';
        var freqLabel = isBiweekly ? 'Every 2 weeks' : 'Day ' + r.due_day;
        var wkAdjLabel = r.weekend_adjust === 'PREV_FRIDAY' ? ' ‚Ä¢ <span style="color:#6be">Wknd‚ÜíFri</span>' : '';

        html += '<div class="rule-item' + (inactive ? ' inactive' : '') + (isEditing ? ' editing' : '') + '" id="rule-' + r.id + '">';
        
        // Summary row (always visible)
        html += '<div class="rule-summary" onclick="toggleRuleEdit(\'' + r.id + '\')">';
        html += '<div class="rule-info">';
        html += '<div class="rule-name">' + esc(r.name) + '</div>';
        html += '<div class="rule-detail">' + freqLabel + ' ‚Ä¢ ' + (r.direction === 'IN' ? 'Income' : 'Expense') + (isBiweekly ? ' <span class="freq-badge">‚ü≥ Bi-weekly</span>' : '') + wkAdjLabel + '</div>';
        html += '</div>';
        html += '<div class="rule-amt ' + amtCls + '">' + sign + money(r.amount) + '</div>';
        html += '<input type="checkbox" ' + (r.active ? 'checked' : '') + ' onclick="event.stopPropagation();toggleRuleActive(\'' + r.id + '\', this.checked)">';
        html += '</div>';
        
        // Inline edit form (hidden until editing)
        html += '<div class="rule-edit-form">';
        html += '<div class="rule-edit-row">';
        html += '<input type="text" id="editRuleName-' + r.id + '" value="' + esc(r.name) + '" placeholder="Name">';
        html += '</div>';
        html += '<div class="rule-edit-row">';
        html += '<input type="number" id="editRuleAmt-' + r.id + '" value="' + r.amount + '" step="0.01" placeholder="Amount">';
        html += '<select id="editRuleDir-' + r.id + '">';
        html += '<option value="OUT"' + (r.direction === 'OUT' ? ' selected' : '') + '>Expense</option>';
        html += '<option value="IN"' + (r.direction === 'IN' ? ' selected' : '') + '>Income</option>';
        html += '</select>';
        html += '</div>';
        // Frequency row
        html += '<div class="rule-edit-row">';
        html += '<select id="editRuleFreq-' + r.id + '" onchange="toggleFreqFields(\'' + r.id + '\')">';
        html += '<option value="MONTHLY"' + (!isBiweekly ? ' selected' : '') + '>Monthly</option>';
        html += '<option value="BIWEEKLY"' + (isBiweekly ? ' selected' : '') + '>Bi-weekly</option>';
        html += '</select>';
        // Due day (for monthly)
        html += '<input type="number" id="editRuleDay-' + r.id + '" value="' + r.due_day + '" min="1" max="31" placeholder="Day" style="' + (isBiweekly ? 'display:none' : '') + '">';
        // Anchor date (for biweekly)
        html += '<input type="date" id="editRuleAnchor-' + r.id + '" value="' + (r.anchor_date || '') + '" placeholder="Known pay date" style="' + (!isBiweekly ? 'display:none' : '') + '">';
        html += '</div>';
        // Weekend adjust row
        var isWkAdj = r.weekend_adjust === 'PREV_FRIDAY';
        html += '<div class="rule-edit-row">';
        html += '<label style="display:flex;align-items:center;gap:6px;font-size:13px;color:#8aa;cursor:pointer;user-select:none;">';
        html += '<input type="checkbox" id="editRuleWeekendAdj-' + r.id + '"' + (isWkAdj ? ' checked' : '') + '> Weekend ‚Üí preceding Friday';
        html += '</label>';
        html += '</div>';
        html += '<div class="rule-edit-actions">';
        html += '<button class="btn-danger" onclick="event.stopPropagation();deleteRuleInline(\'' + r.id + '\')">Delete</button>';
        html += '<div class="left-btns">';
        html += '<button class="btn-secondary" onclick="event.stopPropagation();cancelRuleEdit()">Cancel</button>';
        html += '<button onclick="event.stopPropagation();saveRuleInline(\'' + r.id + '\')">Save</button>';
        html += '</div>';
        html += '</div>';
        html += '</div>';
        
        html += '</div>';
      });
      c.innerHTML = html;
    }
    
    function toggleRuleEdit(id) {
      cancelAddRuleInline(); // close add form if open
      if (editingRuleId === id) {
        editingRuleId = null;
      } else {
        editingRuleId = id;
      }
      renderRules();
    }
    
    function cancelRuleEdit() {
      editingRuleId = null;
      renderRules();
    }

    function toggleFreqFields(id) {
      var freq = $('editRuleFreq-' + id).value;
      var dayEl = $('editRuleDay-' + id);
      var anchorEl = $('editRuleAnchor-' + id);
      if (freq === 'BIWEEKLY') {
        dayEl.style.display = 'none';
        anchorEl.style.display = '';
      } else {
        dayEl.style.display = '';
        anchorEl.style.display = 'none';
      }
    }
    
    function saveRuleInline(id) {
      var name = $('editRuleName-' + id).value.trim();
      var amt = Number($('editRuleAmt-' + id).value || 0);
      var dir = $('editRuleDir-' + id).value;
      var freq = $('editRuleFreq-' + id).value;
      var day = parseInt($('editRuleDay-' + id).value, 10);
      var anchor = $('editRuleAnchor-' + id).value || null;
      
      if (!name) { alert('Name required'); return; }
      if (freq === 'BIWEEKLY') {
        if (!anchor) { alert('Anchor date required for bi-weekly rules.\nPick any known pay date.'); return; }
      } else {
        if (!day || day < 1 || day > 31) { alert('Due day must be 1-31'); return; }
      }
      
      var payload = { ruleId: id, name: name, amount: amt, direction: dir, frequency: freq, active: true, weekendAdjust: $('editRuleWeekendAdj-' + id).checked ? 'PREV_FRIDAY' : 'NONE', regenFromMonth: state.month };
      if (freq === 'BIWEEKLY') {
        payload.anchorDate = anchor;
      } else {
        payload.dueDay = day;
      }
      
      api('api_updateBillRule', payload)
        .then(function() {
          editingRuleId = null;
          loadRules();
          loadMonth(state.month);
        })
        .catch(function(e) { alert('Error: ' + e.message); });
    }
    
    function deleteRuleInline(id) {
      if (!confirm('Delete this recurring bill? Future instances will be removed.')) return;
      
      api('api_deleteBillRule', { ruleId: id })
        .then(function() {
          editingRuleId = null;
          loadRules();
          loadMonth(state.month);
        })
        .catch(function(e) { alert('Error: ' + e.message); });
    }

    // ========== NAVIGATION ==========
    function goPrev() { loadMonth(addMonths(state.month, -1)); }
    function goNext() { loadMonth(addMonths(state.month, 1)); }
    function goToToday() {
      var today = todayISO();
      var todayMonth = today.slice(0, 7);
      if (state.month === todayMonth) {
        // Already on today's month ‚Äî select today on mobile
        if (window.innerWidth <= 768) {
          selectMobileDay(today);
        }
      } else {
        // Navigate to today's month (mobile auto-selects today)
        loadMonth(todayMonth);
      }
    }
    function goToNegativeDay() {
      if (!firstNegativeDay) return;
      // On mobile: select the day in mini calendar
      if (window.innerWidth <= 768) {
        selectMobileDay(firstNegativeDay);
      } else {
        // On desktop: open the day modal
        openDay(firstNegativeDay);
      }
    }

    // ========== DAY MODAL ==========
    function openDay(dateISO) {
      currentDay = dateISO;
      pendingDayBills = []; // Clear pending adds
      pendingDeleteBills = []; // Clear pending deletes
      
      var d = new Date(dateISO + 'T00:00:00Z');
      var dows = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      $('dayModalTitle').textContent = dows[d.getUTCDay()] + ', ' + (d.getUTCMonth() + 1) + '/' + d.getUTCDate();

      renderDayBillsList();
      $('dayAddName').value = '';
      $('dayAddAmt').value = '';
      $('pendingCount').style.display = 'none';
      $('dayModalLoading').classList.remove('active'); // Reset loading state
      $('dayModal').classList.add('open');
    }
    
    function renderDayBillsList() {
      var items = [];
      (state.instances || []).forEach(function(b) {
        if (b.due_date && b.due_date.slice(0, 10) === currentDay) items.push(b);
      });

      // Build lookup for pending deletes
      var deleteIds = {};
      pendingDeleteBills.forEach(function(d) { deleteIds[d.id] = true; });

      var html = '';
      
      // Show existing bills
      if (items.length === 0 && pendingDayBills.length === 0) {
        html = '<div class="empty-state" style="padding:20px;">No bills this day</div>';
      } else {
        items.forEach(function(b) {
          var isIn = b.direction === 'IN';
          var amtCls = isIn ? 'in' : 'out';
          var sign = isIn ? '+' : '-';
          var isRecurring = !!b.bill_rule_id && !b.is_manual;
          var isEdited = !!b.bill_rule_id && b.is_manual;
          var isBiweekly = isRecurring; // badge handled below
          var badge = isRecurring ? ' <span class="recurring-badge">(recurring)</span>' : isEdited ? ' <span class="recurring-badge" style="color:var(--accent-orange)">(edited)</span>' : '';
          
          // Show effective amount (actual if paid, estimated otherwise)
          var effAmt = effectiveAmount(b);
          var hasActual = isPaid(b) && b.paid_amount != null && Number(b.paid_amount) !== Number(b.amount);
          var amtDisplay = sign + money(effAmt);
          if (hasActual) {
            amtDisplay = '<span class="est-amount">' + sign + money(b.amount) + '</span> ‚Üí ' + sign + money(b.paid_amount);
          }
          
          // Check if marked for deletion
          var isMarkedForDelete = deleteIds[b.id];
          var itemClass = 'day-bill-item' + (isMarkedForDelete ? ' marked-for-delete' : '');
          var deleteTitle = isMarkedForDelete ? 'Undo delete' : 'Delete';

          html += '<div class="' + itemClass + '">';
          html += '<div class="day-bill-info" onclick="editBill(\'' + b.id + '\')">';
          html += '<span class="day-bill-name">' + esc(b.name) + badge + '</span>';
          html += '</div>';
          html += '<span class="day-bill-amt ' + amtCls + '">' + amtDisplay + '</span>';
          html += '<input type="checkbox" ' + (b.is_paid ? 'checked' : '') + ' onclick="event.stopPropagation();togglePaid(\'' + b.id + '\', this.checked, ' + Number(b.amount || 0) + ', ' + (!!b.bill_rule_id) + ')"' + (isMarkedForDelete ? ' disabled' : '') + '>';
          // Toggle delete button
          html += '<button class="day-bill-delete" onclick="event.stopPropagation();toggleDeleteBill(\'' + b.id + '\', ' + (b.bill_rule_id ? 'true' : 'false') + ')" title="' + deleteTitle + '">' + (isMarkedForDelete ? '‚Ü©' : '√ó') + '</button>';
          html += '</div>';
        });
        
        // Mark All Paid button (show if any unpaid non-deleted bills exist)
        var unpaidIds = [];
        items.forEach(function(b) {
          if (!isPaid(b) && !deleteIds[b.id]) unpaidIds.push(b.id);
        });
        if (unpaidIds.length > 0) {
          html += '<button class="mark-all-paid-btn" onclick="markAllPaidDay()">‚úì Mark All Paid (' + unpaidIds.length + ')</button>';
        }
        
        // Show pending bills (not yet saved)
        pendingDayBills.forEach(function(p, idx) {
          var isIn = p.direction === 'IN';
          var amtCls = isIn ? 'in' : 'out';
          var sign = isIn ? '+' : '-';
          
          var amtDisplay = sign + money(p.amount);
          if (p.is_paid && p.paid_amount != null && p.paid_amount !== p.amount) {
            amtDisplay = '<span class="est-amount">' + sign + money(p.amount) + '</span> ‚Üí ' + sign + money(p.paid_amount);
          }
          
          html += '<div class="day-bill-item pending-bill">';
          html += '<div class="day-bill-info">';
          html += '<span class="day-bill-name">' + esc(p.name) + ' <span class="recurring-badge" style="color:var(--accent-flow)">(pending)</span></span>';
          html += '</div>';
          html += '<span class="day-bill-amt ' + amtCls + '">' + amtDisplay + '</span>';
          html += '<input type="checkbox" ' + (p.is_paid ? 'checked' : '') + ' onclick="event.stopPropagation();togglePendingPaid(' + idx + ', this.checked, ' + p.amount + ')">';
          html += '<button class="pending-delete" onclick="removePendingBill(' + idx + ')">√ó</button>';
          html += '</div>';
        });
      }

      $('dayBillsList').innerHTML = html;
      
      // Update pending count indicator
      var addCount = pendingDayBills.length;
      var deleteCount = pendingDeleteBills.length;
      if (addCount > 0 || deleteCount > 0) {
        var parts = [];
        if (addCount > 0) parts.push(addCount + ' to add');
        if (deleteCount > 0) parts.push(deleteCount + ' to delete');
        $('pendingCount').textContent = parts.join(', ') + ' ‚Äî Save to confirm';
        $('pendingCount').style.display = 'block';
      } else {
        $('pendingCount').style.display = 'none';
      }
    }
    
    function removePendingBill(idx) {
      pendingDayBills.splice(idx, 1);
      renderDayBillsList();
    }
    
    function togglePendingPaid(idx, paid, estimatedAmt) {
      if (paid) {
        // Show confirm dialog with amount, same UX as existing togglePaid
        var input = prompt('Confirm actual amount paid:', estimatedAmt.toFixed(2));
        if (input === null) {
          // Cancelled - re-render to uncheck
          renderDayBillsList();
          return;
        }
        var actualAmt = Number(input);
        if (!isFinite(actualAmt) || actualAmt < 0) {
          alert('Invalid amount');
          renderDayBillsList();
          return;
        }
        pendingDayBills[idx].is_paid = true;
        pendingDayBills[idx].paid_amount = actualAmt;
      } else {
        pendingDayBills[idx].is_paid = false;
        pendingDayBills[idx].paid_amount = null;
      }
      renderDayBillsList();
    }
    
    function handleDayModalBgClick(event) {
      // Block if currently saving
      if (isSavingDayModal) return;
      // Only trigger if clicking directly on the background, not the modal box
      if (event.target.id === 'dayModal') {
        cancelDayModal();
      }
    }

    function cancelDayModal() {
      // Block if currently saving
      if (isSavingDayModal) return;
      
      var hasChanges = pendingDayBills.length > 0 || pendingDeleteBills.length > 0;
      if (hasChanges) {
        var parts = [];
        if (pendingDayBills.length > 0) parts.push(pendingDayBills.length + ' to add');
        if (pendingDeleteBills.length > 0) parts.push(pendingDeleteBills.length + ' to delete');
        if (!confirm('You have unsaved changes (' + parts.join(', ') + '). Discard?')) {
          return;
        }
      }
      pendingDayBills = [];
      pendingDeleteBills = [];
      $('dayModal').classList.remove('open');
      currentDay = null;
    }
    
    function saveDayModal() {
      var hasAdds = pendingDayBills.length > 0;
      var hasDeletes = pendingDeleteBills.length > 0;
      
      if (!hasAdds && !hasDeletes) {
        // Nothing to save, just close
        $('dayModal').classList.remove('open');
        currentDay = null;
        return;
      }
      
      // Block all interactions during save
      isSavingDayModal = true;
      
      // Show loading overlay
      $('dayModalLoading').classList.add('active');
      
      // Step 1: Batch delete all marked instances (single API call)
      var deletePromise;
      if (hasDeletes) {
        var deleteIds = pendingDeleteBills.map(function(d) { return d.id; });
        deletePromise = api('api_batchDeleteBillInstances', {
          accountId: state.accountId,
          instanceIds: deleteIds
        }).catch(function(e) {
          console.warn('Batch delete error:', e.message);
          return { error: e.message };
        });
      } else {
        deletePromise = Promise.resolve({ ok: true });
      }
      
      deletePromise
        .then(function(deleteResult) {
          if (deleteResult && deleteResult.error) {
            console.warn('Delete failed:', deleteResult.error);
          }
          
          // Step 2: Batch create all new bills (single API call)
          if (hasAdds) {
            var rows = pendingDayBills.map(function(p) {
              return {
                dueDate: currentDay,
                name: p.name,
                amount: p.amount,
                direction: p.direction,
                paid: p.is_paid || false,
                paidAmount: p.is_paid ? p.paid_amount : null
              };
            });
            
            return api('api_batchCreateManualBills', {
              accountId: state.accountId,
              billMonth: state.month,
              rows: rows
            });
          }
          return { ok: true };
        })
        .then(function(res) {
          isSavingDayModal = false;
          $('dayModalLoading').classList.remove('active');
          pendingDayBills = [];
          pendingDeleteBills = [];
          $('dayModal').classList.remove('open');
          currentDay = null;
          refreshAfterEdit();
        })
        .catch(function(e) {
          isSavingDayModal = false;
          $('dayModalLoading').classList.remove('active');
          alert('Error saving changes: ' + e.message);
        });
    }
    
    function closeDayModal() {
      // Legacy function - now calls cancel
      cancelDayModal();
    }

    function togglePaid(id, paid, estimatedAmt, isRecurring) {
      if (paid) {
        if (isRecurring) {
          // Recurring bill ‚Äî prompt to confirm/adjust estimated amount
          var actualStr = prompt('Actual amount paid?\n(Leave as-is if estimate was correct)', estimatedAmt ? estimatedAmt.toFixed(2) : '0.00');
          if (actualStr === null) {
            // User cancelled - uncheck the checkbox
            refreshDayModal();
            return;
          }
          var actualAmt = parseFloat(actualStr);
          if (!isFinite(actualAmt) || actualAmt < 0) {
            alert('Invalid amount');
            refreshDayModal();
            return;
          }
          
          var args = { billInstanceId: id, isPaid: true };
          // Only send paidAmount if it differs from estimated
          if (Math.abs(actualAmt - (estimatedAmt || 0)) > 0.001) {
            args.paidAmount = actualAmt;
          }
          
          api('api_setBillPaid', args)
            .then(function() { refreshAfterEdit(); })
            .catch(function(e) { alert('Error: ' + e.message); });
        } else {
          // Manual entry ‚Äî mark paid at entered amount, no prompt needed
          api('api_setBillPaid', { billInstanceId: id, isPaid: true })
            .then(function() { refreshAfterEdit(); })
            .catch(function(e) { alert('Error: ' + e.message); });
        }
      } else {
        // Unmarking paid - no prompt needed
        api('api_unsetBillPaid', { billInstanceId: id })
          .then(function() { refreshAfterEdit(); })
          .catch(function(e) { alert('Error: ' + e.message); });
      }
    }

    function markAllPaidDay() {
      if (!currentDay) return;
      var unpaidIds = [];
      (state.instances || []).forEach(function(b) {
        if (b.due_date && b.due_date.slice(0, 10) === currentDay && !isPaid(b)) {
          unpaidIds.push(b.id);
        }
      });
      if (unpaidIds.length === 0) return;

      // Show loading
      $('dayModalLoading').classList.add('active');
      isSavingDayModal = true;

      api('api_batchSetBillPaid', { instanceIds: unpaidIds, isPaid: true })
        .then(function() {
          isSavingDayModal = false;
          $('dayModalLoading').classList.remove('active');
          refreshAfterEdit();
        })
        .catch(function(e) {
          isSavingDayModal = false;
          $('dayModalLoading').classList.remove('active');
          alert('Error marking paid: ' + e.message);
        });
    }

    function quickAddDay() {
      var nameEl = $('dayAddName');
      var amtEl = $('dayAddAmt');
      var name = nameEl.value.trim();
      var amtStr = amtEl.value.trim();

      if (!name) { alert('Enter name'); return; }
      if (!amtStr) { alert('Enter amount'); return; }

      var signed = Number(amtStr);
      if (!isFinite(signed) || signed === 0) { alert('Amount must be non-zero'); return; }

      var dir = signed >= 0 ? 'IN' : 'OUT';
      var amt = Math.abs(signed);

      // Add to pending queue (will be saved on Save & Close)
      pendingDayBills.push({
        name: name,
        amount: amt,
        direction: dir,
        is_paid: false,
        paid_amount: null
      });
      
      // Clear inputs and refocus for rapid entry
      nameEl.value = '';
      amtEl.value = '';
      nameEl.focus();
      
      // Re-render the list to show pending bill
      renderDayBillsList();
    }

    // ========== EDIT BILL ==========
    function editBill(id) {
      var b = null;
      (state.instances || []).forEach(function(x) { if (x.id === id) b = x; });
      if (!b) return;

      selectedBill = b;

      // If it has a rule AND hasn't been manually edited yet, show choice modal
      // If is_manual is true, it's already been detached/edited, so edit directly
      if (b.bill_rule_id && !b.is_manual) {
        // Recurring and not yet edited - show choice modal
        $('editChoiceName').textContent = b.name + ' - ' + money(b.amount);
        $('editChoiceModal').classList.add('open');
      } else {
        // Manual or already detached - edit directly
        openBillEditModal(b);
      }
    }

    function closeEditChoiceModal() {
      $('editChoiceModal').classList.remove('open');
      // Don't clear selectedBill here - it's needed by editThisOne/editAllFuture
    }

    function editThisOne() {
      // Save reference before closing
      var bill = selectedBill;
      $('editChoiceModal').classList.remove('open');
      if (!bill) return;
      selectedBill = null;
      openBillEditModal(bill, true);
    }

    function editAllFuture() {
      // Save reference before closing
      var bill = selectedBill;
      $('editChoiceModal').classList.remove('open');
      closeDayModal();
      if (!bill || !bill.bill_rule_id) return;
      selectedBill = null;
      
      // Open rules panel and expand that rule for inline editing
      editingRuleId = bill.bill_rule_id;
      openRulesPanel();
      
      // Scroll to the rule after a brief delay
      setTimeout(function() {
        var el = $('rule-' + bill.bill_rule_id);
        if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }, 100);
    }

    function openBillEditModal(b, detaching) {
      $('billEditId').value = b.id;
      $('billEditTitle').textContent = detaching ? 'Edit This Instance' : 'Edit Bill';
      $('billEditName').value = b.name || '';
      $('billEditAmt').value = b.amount || '';
      $('billEditDir').value = b.direction || 'OUT';
      $('billEditDue').value = b.due_date ? b.due_date.slice(0, 10) : '';
      $('billEditModal').classList.add('open');
    }

    function closeBillEditModal() {
      $('billEditModal').classList.remove('open');
    }

    function saveBillEdit() {
      var id = $('billEditId').value;
      var name = $('billEditName').value.trim();
      var amt = Number($('billEditAmt').value || 0);
      var dir = $('billEditDir').value;
      var due = $('billEditDue').value || null;

      if (!name) { alert('Name required'); return; }

      // Find the bill to check if it's being detached from a rule
      var b = null;
      (state.instances || []).forEach(function(x) { if (x.id === id) b = x; });

      // If it has a rule AND hasn't been manually edited, use detach endpoint
      // This marks is_manual=true while keeping bill_rule_id to prevent duplicates
      if (b && b.bill_rule_id && !b.is_manual) {
        console.log('Detaching bill:', id, 'from rule:', b.bill_rule_id);
        api('api_detachBillInstance', {
          instanceId: id,
          name: name,
          amount: amt,
          direction: dir,
          dueDate: due
        })
          .then(function(res) {
            console.log('Detach success:', res);
            closeBillEditModal();
            refreshAfterEdit();
          })
          .catch(function(e) {
            console.error('Detach failed:', e);
            alert('Error detaching bill: ' + e.message + '\n\nMake sure you deployed the updated edge function.');
          });
      } else {
        // Already manual or already detached - use normal update
        api('api_updateManualBill', { instanceId: id, name: name, amount: amt, direction: dir, dueDate: due })
          .then(function() {
            closeBillEditModal();
            refreshAfterEdit();
          })
          .catch(function(e) { alert('Error: ' + e.message); });
      }
    }

    function deleteBillEdit() {
      var id = $('billEditId').value;
      if (!id || !confirm('Delete this bill?')) return;

      // Check if it's a recurring bill being deleted
      var b = null;
      (state.instances || []).forEach(function(x) { if (x.id === id) b = x; });

      if (b && b.bill_rule_id) {
        // Delete recurring instance via new API endpoint
        api('api_deleteBillInstance', { instanceId: id })
          .then(function() {
            closeBillEditModal();
            refreshAfterEdit();
          })
          .catch(function(e) { alert('Error: ' + e.message); });
      } else {
        // Delete manual bill via existing API
        api('api_deleteManualBill', { instanceId: id })
          .then(function() {
            closeBillEditModal();
            refreshAfterEdit();
          })
          .catch(function(e) { alert('Error: ' + e.message); });
      }
    }

    function toggleDeleteBill(id, hasRule) {
      // Check if already in delete queue
      var idx = -1;
      pendingDeleteBills.forEach(function(d, i) {
        if (d.id === id) idx = i;
      });
      
      if (idx >= 0) {
        // Already marked - remove from queue (undo)
        pendingDeleteBills.splice(idx, 1);
      } else {
        // Not marked - add to queue
        pendingDeleteBills.push({ id: id, hasRule: hasRule });
      }
      
      renderDayBillsList();
    }

    function refreshAfterEdit() {
      // Reload month data and refresh day modal if open
      api('api_loadBillMonth', { month: state.month, accountId: state.accountId })
        .then(function(d) {
          state.month = d.month;
          state.startBal = Number(d.startingBalance || 0);
          state.instances = d.instances || [];
          state.totals = d.totals || null;
          render();
          // Refresh day modal if it's open (desktop)
          if (currentDay) {
            refreshDayModal();
          }
          // Refresh mobile day view if active
          if (mobileViewMode === 'day') {
            renderSingleDay();
          }
        })
        .catch(function(e) { showError('Refresh failed: ' + e.message); });
    }

    function refreshDayModal() {
      if (!currentDay) return;
      // Re-render the full day bills list (includes delete buttons, pending state, etc.)
      renderDayBillsList();
    }

    // ========== RULES ==========
    function toggleAddRuleInline() {
      cancelRuleEdit(); // close any open edit
      var form = $('addRuleForm');
      var btn = $('addRuleBtn');
      if (form.style.display !== 'block') {
        form.style.display = 'block';
        btn.style.display = 'none';
        $('newRuleName').value = '';
        $('newRuleAmt').value = '';
        $('newRuleDir').value = 'OUT';
        $('newRuleFreq').value = 'MONTHLY';
        $('newRuleDay').value = '';
        $('newRuleAnchor').value = '';
        $('newRuleWeekendAdj').checked = false;
        toggleNewRuleFreqFields();
        $('newRuleName').focus();
      } else {
        cancelAddRuleInline();
      }
    }

    function cancelAddRuleInline() {
      $('addRuleForm').style.display = 'none';
      $('addRuleBtn').style.display = '';
    }

    function toggleNewRuleFreqFields() {
      var freq = $('newRuleFreq').value;
      $('newRuleDay').style.display = freq === 'MONTHLY' ? '' : 'none';
      $('newRuleAnchor').style.display = freq === 'BIWEEKLY' ? '' : 'none';
    }

    function saveNewRuleInline() {
      var name = $('newRuleName').value.trim();
      var amt = Number($('newRuleAmt').value || 0);
      var dir = $('newRuleDir').value;
      var freq = $('newRuleFreq').value;
      var day = parseInt($('newRuleDay').value, 10);
      var anchor = $('newRuleAnchor').value || null;

      if (!name) { alert('Name required'); return; }
      if (freq === 'BIWEEKLY') {
        if (!anchor) { alert('Pick any known pay date as the anchor.'); return; }
      } else {
        if (!day || day < 1 || day > 31) { alert('Due day must be 1-31'); return; }
      }

      var payload = { accountId: state.accountId, name: name, amount: amt, direction: dir, frequency: freq, active: true, weekendAdjust: $('newRuleWeekendAdj').checked ? 'PREV_FRIDAY' : 'NONE' };
      if (freq === 'BIWEEKLY') { payload.anchorDate = anchor; } else { payload.dueDay = day; }

      api('api_createBillRule', payload)
        .then(function() {
          cancelAddRuleInline();
          loadRules();
          loadMonth(state.month);
        })
        .catch(function(e) { alert('Error: ' + e.message); });
    }

    // Legacy ‚Äî redirect to inline
    function openAddRule() { toggleAddRuleInline(); }

    function openEditRule(id) {
      var r = null;
      (state.rules || []).forEach(function(x) { if (x.id === id) r = x; });
      if (!r) return;
      // Use inline edit via toggleRuleEdit
      editingRuleId = id;
      renderRules();
    }

    function closeRuleModal() { $('ruleModal').classList.remove('open'); }

    function saveRule() {
      var mode = $('ruleMode').value;
      var id = $('ruleId').value;
      var name = $('ruleName').value.trim();
      var amt = Number($('ruleAmt').value || 0);
      var dir = $('ruleDir').value;
      var freq = $('ruleFreq').value;
      var day = parseInt($('ruleDay').value, 10);
      var anchor = $('ruleAnchor').value || null;
      var active = $('ruleActive').value === '1';

      if (!name) { alert('Name required'); return; }
      if (freq === 'BIWEEKLY') {
        if (!anchor) { alert('Anchor date required for bi-weekly rules.\nPick any known pay date.'); return; }
      } else {
        if (!day || day < 1 || day > 31) { alert('Due day must be 1-31'); return; }
      }

      var p;
      if (mode === 'edit') {
        var payload = { ruleId: id, name: name, amount: amt, direction: dir, frequency: freq, active: active, regenFromMonth: state.month };
        if (freq === 'BIWEEKLY') { payload.anchorDate = anchor; } else { payload.dueDay = day; }
        p = api('api_updateBillRule', payload);
      } else {
        var payload = { accountId: state.accountId, name: name, amount: amt, direction: dir, frequency: freq, active: active };
        if (freq === 'BIWEEKLY') { payload.anchorDate = anchor; } else { payload.dueDay = day; }
        p = api('api_createBillRule', payload);
      }

      p.then(function() {
        closeRuleModal();
        loadRules();
        loadMonth(state.month);
      }).catch(function(e) { alert('Error: ' + e.message); });
    }

    function deleteRule() {
      var id = $('ruleId').value;
      if (!id || !confirm('Delete this rule? Future instances will be removed.')) return;

      api('api_deleteBillRule', { ruleId: id })
        .then(function() {
          closeRuleModal();
          loadRules();
          loadMonth(state.month);
        })
        .catch(function(e) { alert('Error: ' + e.message); });
    }

    function toggleRuleActive(id, active) {
      api('api_updateBillRule', { ruleId: id, active: active, regenFromMonth: state.month })
        .then(function() { loadRules(); loadMonth(state.month); })
        .catch(function(e) { alert('Error: ' + e.message); loadRules(); });
    }

    // ========== FILTER MODAL (IN/OUT) ==========
    var currentFilterDirection = null;

    function showFilteredBills(direction) {
      currentFilterDirection = direction;
      var title = direction === 'IN' ? 'Income This Month' : 'Expenses This Month';
      $('filterModalTitle').textContent = title;
      $('copyMsg').style.display = 'none';

      var filtered = (state.instances || []).filter(function(b) {
        return b.direction === direction;
      });

      // Sort by due_date
      filtered.sort(function(a, b) {
        var da = a.due_date || '';
        var db = b.due_date || '';
        return da.localeCompare(db);
      });

      var html = '';
      if (filtered.length === 0) {
        html = '<div class="empty-state" style="padding:20px;">No ' + (direction === 'IN' ? 'income' : 'expenses') + ' this month</div>';
      } else {
        filtered.forEach(function(b) {
          var dateStr = b.due_date ? b.due_date.slice(5) : '-';
          var amtCls = direction === 'IN' ? 'in' : 'out';
          var sign = direction === 'IN' ? '+' : '-';

          var effAmt = effectiveAmount(b);
          var hasActual = isPaid(b) && b.paid_amount != null && Number(b.paid_amount) !== Number(b.amount);
          var amtText = hasActual ? '<span class="est-amount">' + sign + money(b.amount) + '</span> ' + sign + money(b.paid_amount) : sign + money(effAmt);

          html += '<div class="filter-bill-item">';
          html += '<span class="filter-bill-date">' + esc(dateStr) + '</span>';
          html += '<span class="filter-bill-name">' + esc(b.name) + '</span>';
          html += '<span class="filter-bill-amt ' + amtCls + '">' + amtText + '</span>';
          html += '</div>';
        });
      }

      $('filterBillsList').innerHTML = html;
      $('filterModal').classList.add('open');
    }

    function copyFilteredBills() {
      if (!currentFilterDirection) return;

      var filtered = (state.instances || []).filter(function(b) {
        return b.direction === currentFilterDirection;
      });

      filtered.sort(function(a, b) {
        var da = a.due_date || '';
        var db = b.due_date || '';
        return da.localeCompare(db);
      });

      // Build tab-separated table
      var lines = [];
      lines.push('Date\tName\tAmount');
      filtered.forEach(function(b) {
        var dateStr = b.due_date ? b.due_date.slice(0, 10) : '';
        var sign = b.direction === 'IN' ? '' : '-';
        var amt = sign + effectiveAmount(b).toFixed(2);
        lines.push(dateStr + '\t' + (b.name || '') + '\t' + amt);
      });

      var text = lines.join('\n');

      navigator.clipboard.writeText(text).then(function() {
        $('copyMsg').style.display = 'block';
        setTimeout(function() {
          $('copyMsg').style.display = 'none';
        }, 2000);
      }).catch(function(e) {
        alert('Copy failed: ' + e.message);
      });
    }

    function closeFilterModal() {
      $('filterModal').classList.remove('open');
      currentFilterDirection = null;
    }

    // ========== BALANCE SHEET ==========
    function showBalanceSheet() {
      var monthParts = state.month.split('-');
      var monthName = fmtMonth(state.month);
      $('balanceSheetTitle').textContent = 'Balance Sheet ‚Äî ' + monthName;

      var income = (state.instances || []).filter(function(b) { return b.direction === 'IN'; });
      var expenses = (state.instances || []).filter(function(b) { return b.direction === 'OUT'; });

      income.sort(function(a, b) { return (a.due_date || '').localeCompare(b.due_date || ''); });
      expenses.sort(function(a, b) { return (a.due_date || '').localeCompare(b.due_date || ''); });

      var t = state.totals || {};
      var inT = Number(t.in_total || 0);
      var outT = Number(t.out_total || 0);
      var endB = state.startBal + inT - outT;
      var netChange = inT - outT;

      var html = '';

      // Starting Balance
      html += '<div class="bal-sheet-highlight">';
      html += '<span>Starting Balance</span>';
      html += '<span style="color:' + (state.startBal >= 0 ? 'var(--accent-flow)' : 'var(--accent-red)') + '">' + money(state.startBal) + '</span>';
      html += '</div>';

      // Income
      html += '<div class="bal-sheet-section" style="color:var(--accent-green)">Income</div>';
      if (income.length === 0) {
        html += '<div class="bal-sheet-item"><span class="bal-sheet-item-name" style="color:var(--text-muted)">No income this month</span></div>';
      } else {
        income.forEach(function(b) {
          var dateStr = b.due_date ? b.due_date.slice(8, 10) : '--';
          var amt = effectiveAmount(b);
          html += '<div class="bal-sheet-item">';
          html += '<span class="bal-sheet-item-date">' + dateStr + '</span>';
          html += '<span class="bal-sheet-item-name">' + esc(b.name) + '</span>';
          html += '<span class="bal-sheet-item-amt" style="color:var(--accent-green)">+' + money(amt) + '</span>';
          html += '</div>';
        });
      }
      html += '<div class="bal-sheet-divider"></div>';
      html += '<div class="bal-sheet-total">';
      html += '<span>Total Income</span>';
      html += '<span style="color:var(--accent-green)">+' + money(inT) + '</span>';
      html += '</div>';

      // Expenses
      html += '<div class="bal-sheet-section" style="color:var(--accent-red)">Expenses</div>';
      if (expenses.length === 0) {
        html += '<div class="bal-sheet-item"><span class="bal-sheet-item-name" style="color:var(--text-muted)">No expenses this month</span></div>';
      } else {
        expenses.forEach(function(b) {
          var dateStr = b.due_date ? b.due_date.slice(8, 10) : '--';
          var amt = effectiveAmount(b);
          html += '<div class="bal-sheet-item">';
          html += '<span class="bal-sheet-item-date">' + dateStr + '</span>';
          html += '<span class="bal-sheet-item-name">' + esc(b.name) + '</span>';
          html += '<span class="bal-sheet-item-amt" style="color:var(--accent-red)">-' + money(amt) + '</span>';
          html += '</div>';
        });
      }
      html += '<div class="bal-sheet-divider"></div>';
      html += '<div class="bal-sheet-total">';
      html += '<span>Total Expenses</span>';
      html += '<span style="color:var(--accent-red)">-' + money(outT) + '</span>';
      html += '</div>';

      // Net Change + Ending Balance
      html += '<div style="margin-top:8px"></div>';
      html += '<div class="bal-sheet-total">';
      html += '<span>Net Change</span>';
      html += '<span style="color:' + (netChange >= 0 ? 'var(--accent-green)' : 'var(--accent-red)') + '">' + (netChange >= 0 ? '+' : '-') + money(Math.abs(netChange)) + '</span>';
      html += '</div>';

      html += '<div class="bal-sheet-highlight">';
      html += '<span>Ending Balance</span>';
      html += '<span style="color:' + (endB >= 0 ? 'var(--accent-flow)' : 'var(--accent-red)') + '">' + money(endB) + '</span>';
      html += '</div>';

      $('balanceSheetContent').innerHTML = html;
      $('balanceSheetModal').classList.add('open');
    }

    function closeBalanceSheet() {
      $('balanceSheetModal').classList.remove('open');
    }

    function copyBalanceSheet() {
      var t = state.totals || {};
      var inT = Number(t.in_total || 0);
      var outT = Number(t.out_total || 0);
      var endB = state.startBal + inT - outT;
      var monthName = fmtMonth(state.month);

      var lines = [];
      lines.push('Balance Sheet ‚Äî ' + monthName);
      lines.push('');
      lines.push('Starting Balance\t' + money(state.startBal));
      lines.push('');
      lines.push('INCOME');
      lines.push('Date\tName\tAmount');
      (state.instances || []).filter(function(b) { return b.direction === 'IN'; })
        .sort(function(a, b) { return (a.due_date || '').localeCompare(b.due_date || ''); })
        .forEach(function(b) {
          lines.push(b.due_date.slice(0, 10) + '\t' + b.name + '\t+' + effectiveAmount(b).toFixed(2));
        });
      lines.push('Total Income\t\t+' + inT.toFixed(2));
      lines.push('');
      lines.push('EXPENSES');
      lines.push('Date\tName\tAmount');
      (state.instances || []).filter(function(b) { return b.direction === 'OUT'; })
        .sort(function(a, b) { return (a.due_date || '').localeCompare(b.due_date || ''); })
        .forEach(function(b) {
          lines.push(b.due_date.slice(0, 10) + '\t' + b.name + '\t-' + effectiveAmount(b).toFixed(2));
        });
      lines.push('Total Expenses\t\t-' + outT.toFixed(2));
      lines.push('');
      lines.push('Net Change\t\t' + (inT - outT >= 0 ? '+' : '-') + Math.abs(inT - outT).toFixed(2));
      lines.push('Ending Balance\t\t' + endB.toFixed(2));

      navigator.clipboard.writeText(lines.join('\n')).then(function() {
        $('balCopyMsg').style.display = 'block';
        setTimeout(function() { $('balCopyMsg').style.display = 'none'; }, 2000);
      }).catch(function(e) { alert('Copy failed: ' + e.message); });
    }

    // ========== RECONCILE ==========
    var reconcileDuplicates = []; // [{groupId, items: [{id, name, date, amount, direction, is_paid}], reason}]
    var reconcileDeletedIds = {}; // track deleted during this session

    function computeActualBalance() {
      var paidIn = 0, paidOut = 0;
      (state.instances || []).forEach(function(b) {
        if (!isPaid(b)) return;
        if (reconcileDeletedIds[b.id]) return;
        var amt = effectiveAmount(b);
        if (b.direction === 'IN') paidIn += amt;
        else paidOut += amt;
      });
      return state.startBal + paidIn - paidOut;
    }

    function normalizeName(s) {
      return (s || '').trim().toLowerCase().replace(/[^a-z0-9\s]/g, '').replace(/\s+/g, ' ');
    }

    function namesMatch(a, b) {
      var na = normalizeName(a), nb = normalizeName(b);
      if (!na || !nb) return false;
      // Exact match
      if (na === nb) return 'exact';
      // One contains the other
      if (na.indexOf(nb) >= 0 || nb.indexOf(na) >= 0) return 'contains';
      // Token overlap ‚Äî 70%+ of shorter name's tokens in longer
      var tokA = na.split(' ').filter(Boolean);
      var tokB = nb.split(' ').filter(Boolean);
      var shorter = tokA.length <= tokB.length ? tokA : tokB;
      var longer = tokA.length > tokB.length ? tokA : tokB;
      if (shorter.length === 0) return false;
      var longerStr = ' ' + longer.join(' ') + ' ';
      var hits = 0;
      shorter.forEach(function(t) {
        if (longerStr.indexOf(' ' + t + ' ') >= 0) hits++;
      });
      if (hits / shorter.length >= 0.7) return 'token';
      return false;
    }

    function findDuplicates() {
      var instances = (state.instances || []).filter(function(b) {
        return !reconcileDeletedIds[b.id];
      });
      var groups = [];
      var groupId = 0;
      var used = {};

      for (var i = 0; i < instances.length; i++) {
        if (used[instances[i].id]) continue;
        for (var j = i + 1; j < instances.length; j++) {
          if (used[instances[j].id]) continue;
          var a = instances[i], b = instances[j];
          var reason = null;
          var confidence = null; // 'likely' or 'possible'

          var sameAmt = Math.abs(Number(a.amount) - Number(b.amount)) < 0.01;
          var nameMatchType = namesMatch(a.name, b.name);
          var sameDate = a.due_date && b.due_date && a.due_date.slice(0, 10) === b.due_date.slice(0, 10);
          var sameDir = a.direction === b.direction;

          var diffDays = 0;
          if (a.due_date && b.due_date) {
            var d1 = new Date(a.due_date + 'T12:00:00'), d2 = new Date(b.due_date + 'T12:00:00');
            diffDays = Math.round(Math.abs(d1 - d2) / (1000 * 60 * 60 * 24));
          }
          var sameWeek = diffDays <= 7;
          var dayLabel = diffDays === 0 ? 'same date' : diffDays + ' day' + (diffDays !== 1 ? 's' : '') + ' apart';

          // Only flag duplicates within the same direction
          if (!sameDir) continue;

          // Skip if both are recurring (not manually edited) ‚Äî they're supposed to repeat
          var aRecurring = !!a.bill_rule_id && !a.is_manual;
          var bRecurring = !!b.bill_rule_id && !b.is_manual;
          if (aRecurring && bRecurring) continue;

          // üî¥ Likely: exact/fuzzy name + same amount + same date
          if (nameMatchType && sameAmt && sameDate) {
            reason = nameMatchType === 'exact'
              ? 'Exact match ‚Äî same name, amount, and date'
              : 'Similar name and same amount on same date';
            confidence = 'likely';
          }
          // üî¥ Likely: exact/fuzzy name + same amount, anywhere in month
          else if (nameMatchType && sameAmt && !sameDate) {
            reason = (nameMatchType === 'exact' ? 'Same name' : 'Similar name') + ' and amount, ' + dayLabel;
            confidence = 'likely';
          }
          // üü° Possible: same amount + same date, different name
          else if (sameAmt && sameDate && !nameMatchType) {
            reason = 'Same amount and date, different name';
            confidence = 'possible';
          }
          // üü° Possible: same amount + same week, different name
          else if (sameAmt && sameWeek && !sameDate && !nameMatchType) {
            reason = 'Same amount within same week (' + dayLabel + '), different name';
            confidence = 'possible';
          }

          if (reason) {
            used[a.id] = true;
            used[b.id] = true;
            groups.push({
              groupId: groupId++,
              items: [a, b],
              reason: reason,
              confidence: confidence
            });
            break; // Move on to next i ‚Äî a is used
          }
        }
      }
      // Sort: likely first, then possible
      groups.sort(function(a, b) {
        if (a.confidence === b.confidence) return 0;
        return a.confidence === 'likely' ? -1 : 1;
      });
      return groups;
    }

    function openReconcile() {
      closeBalanceSheet();
      reconcileDeletedIds = {};
      $('reconcileMonthLabel').textContent = fmtMonth(state.month);
      renderReconcile();
      $('reconcileModal').classList.add('open');
    }

    function closeReconcile() {
      $('reconcileModal').classList.remove('open');
    }

    function renderReconcile() {
      var actualBal = computeActualBalance();
      reconcileDuplicates = findDuplicates();

      var html = '';

      // Step 1: Bank balance input
      html += '<div class="reconcile-input-row">';
      html += '<label for="reconcileBankInput">Bank balance:</label>';
      html += '<input type="number" id="reconcileBankInput" step="0.01" placeholder="Enter your bank balance" oninput="updateReconcileDiff()">';
      html += '</div>';

      // Comparison result (updates live)
      html += '<div class="reconcile-result" id="reconcileResultBox" style="display:none;">';
      html += '<div class="reconcile-result-row">';
      html += '<span style="color:var(--text-secondary)">FlowCal (paid only)</span>';
      html += '<span id="reconcileActualBal" style="color:var(--accent-flow)">' + money(actualBal) + '</span>';
      html += '</div>';
      html += '<div class="reconcile-result-row">';
      html += '<span style="color:var(--text-secondary)">Bank says</span>';
      html += '<span id="reconcileBankVal">‚Äî</span>';
      html += '</div>';
      html += '<div class="reconcile-result-row highlight">';
      html += '<span>Difference</span>';
      html += '<span id="reconcileDiffVal">‚Äî</span>';
      html += '</div>';
      html += '</div>';

      // Difference analysis (populated dynamically by updateReconcileDiff)
      html += '<div id="reconcileDiffAnalysis"></div>';

      // Step 2: Duplicate check
      html += '<div class="reconcile-section-title">Duplicate Check</div>';

      if (reconcileDuplicates.length === 0) {
        html += '<div class="reconcile-ok"><span class="check-icon">‚úì</span>No potential duplicates found</div>';
      } else {
        html += '<div style="font-size:13px;color:var(--text-secondary);margin-bottom:8px;">';
        var likelyCount = reconcileDuplicates.filter(function(g) { return g.confidence === 'likely'; }).length;
        var possibleCount = reconcileDuplicates.filter(function(g) { return g.confidence === 'possible'; }).length;
        var parts = [];
        if (likelyCount > 0) parts.push(likelyCount + ' likely');
        if (possibleCount > 0) parts.push(possibleCount + ' possible');
        html += 'Found ' + parts.join(' and ') + ' potential duplicate' + (reconcileDuplicates.length !== 1 ? 's' : '') + ':';
        html += '</div>';

        reconcileDuplicates.forEach(function(group) {
          var borderColor = group.confidence === 'likely' ? 'var(--accent-red)' : 'var(--accent-orange)';
          var tagColor = group.confidence === 'likely' ? 'var(--accent-red)' : 'var(--accent-orange)';
          var tagLabel = group.confidence === 'likely' ? 'Likely duplicate' : 'Possible duplicate';
          html += '<div class="reconcile-match" id="reconcileGroup' + group.groupId + '" style="border-left-color:' + borderColor + '">';
          html += '<div class="reconcile-match-header" style="color:' + tagColor + '">' + tagLabel + ' ‚Äî ' + esc(group.reason) + '</div>';
          group.items.forEach(function(b, idx) {
            var isIn = b.direction === 'IN';
            var sign = isIn ? '+' : '-';
            var dateStr = b.due_date ? fmtDateShort(b.due_date.slice(0, 10)) : 'No date';
            var paidTag = isPaid(b) ? ' ‚úì' : '';
            html += '<div class="reconcile-match-item">';
            html += '<div class="item-detail">';
            html += '<div class="item-name">' + esc(b.name) + paidTag + '</div>';
            html += '<div class="item-meta">' + dateStr + (b.bill_rule_id && !b.is_manual ? ' ¬∑ recurring' : ' ¬∑ manual') + '</div>';
            html += '</div>';
            html += '<span class="item-amt" style="color:' + (isIn ? 'var(--accent-green)' : 'var(--accent-red)') + '">' + sign + money(effectiveAmount(b)) + '</span>';
            html += '</div>';
          });
          html += '<div class="reconcile-match-actions">';
          html += '<button class="btn-keep" onclick="keepBothDuplicates(' + group.groupId + ')">Keep Both</button>';
          // Offer to delete each item
          group.items.forEach(function(b, idx) {
            var label = group.items.length === 2 ? (idx === 0 ? 'Delete 1st' : 'Delete 2nd') : 'Delete "' + esc(b.name).substring(0, 12) + '"';
            html += '<button class="btn-delete-dup" onclick="deleteReconcileDup(' + group.groupId + ',' + idx + ')">' + label + '</button>';
          });
          html += '</div>';
          html += '</div>';
        });
      }

      $('reconcileContent').innerHTML = html;

      // Restore bank input value if it was set
      var savedVal = $('reconcileModal').getAttribute('data-bank-val');
      if (savedVal) {
        $('reconcileBankInput').value = savedVal;
        updateReconcileDiff();
      }
    }

    function fmtDateShort(iso) {
      var d = new Date(iso + 'T12:00:00');
      var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      return months[d.getMonth()] + ' ' + d.getDate();
    }

    function updateReconcileDiff() {
      var input = $('reconcileBankInput');
      var val = parseFloat(input.value);
      var box = $('reconcileResultBox');
      var analysisEl = $('reconcileDiffAnalysis');

      // Save value for re-renders
      $('reconcileModal').setAttribute('data-bank-val', input.value);

      if (!isFinite(val)) {
        box.style.display = 'none';
        analysisEl.innerHTML = '';
        return;
      }
      box.style.display = 'block';

      var actualBal = computeActualBalance();
      $('reconcileActualBal').textContent = money(actualBal);
      $('reconcileBankVal').textContent = money(val);

      var diff = val - actualBal;
      var diffEl = $('reconcileDiffVal');
      if (Math.abs(diff) < 0.01) {
        diffEl.textContent = '$0.00 ‚úì';
        diffEl.style.color = 'var(--accent-green)';
        analysisEl.innerHTML = '';
        return;
      } else {
        diffEl.textContent = (diff >= 0 ? '+' : '-') + money(Math.abs(diff));
        diffEl.style.color = diff >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
      }

      // Run difference analysis
      var absDiff = Math.abs(diff);
      var bankHigher = diff > 0; // bank has more than FlowCal thinks
      var singles = findDiffSingles(absDiff, bankHigher);
      var pairs = findDiffPairs(absDiff, bankHigher);

      var html = '';
      if (singles.length > 0 || pairs.length > 0) {
        html += '<div class="reconcile-section-title">Possible Explanations</div>';

        if (bankHigher) {
          html += '<div style="font-size:12px;color:var(--text-muted);margin-bottom:8px;">Bank is higher ‚Äî looking for unrecorded income or overstated expenses</div>';
        } else {
          html += '<div style="font-size:12px;color:var(--text-muted);margin-bottom:8px;">Bank is lower ‚Äî looking for unrecorded expenses or missing payments</div>';
        }

        singles.forEach(function(m) {
          html += renderDiffMatch(m);
        });

        if (pairs.length > 0) {
          html += '<button class="reconcile-pairs-toggle" onclick="showReconcilePairs()">';
          html += 'Check for two-entry combinations (' + pairs.length + ' found)';
          html += '</button>';
          html += '<div id="reconcilePairsContainer" style="display:none;">';
          pairs.forEach(function(m) {
            html += renderDiffMatch(m);
          });
          html += '</div>';
        }
      }

      analysisEl.innerHTML = html;
    }

    function findDiffSingles(absDiff, bankHigher) {
      var results = [];
      (state.instances || []).forEach(function(b) {
        if (reconcileDeletedIds[b.id]) return;
        var amt = effectiveAmount(b);
        if (Math.abs(amt - absDiff) > 0.01) return;

        var paid = isPaid(b);
        var explanation = null;

        if (bankHigher) {
          // Bank has more money. Possible reasons:
          // - Unpaid income for this amount (you got paid but didn't mark it)
          // - Paid expense for this amount (marked paid but wasn't actually charged)
          if (!paid && b.direction === 'IN') {
            explanation = 'Unpaid income matches difference ‚Äî did this already come in?';
          } else if (paid && b.direction === 'OUT') {
            explanation = 'Paid expense matches difference ‚Äî was this actually charged?';
          }
        } else {
          // Bank has less money. Possible reasons:
          // - Unpaid expense for this amount (charged but you didn't mark paid)
          // - Paid income for this amount (marked received but hasn't actually hit)
          if (!paid && b.direction === 'OUT') {
            explanation = 'Unpaid expense matches difference ‚Äî was this already charged?';
          } else if (paid && b.direction === 'IN') {
            explanation = 'Paid income matches difference ‚Äî did this actually come in?';
          }
        }

        if (explanation) {
          results.push({
            type: 'single',
            explanation: explanation,
            items: [b]
          });
        }
      });
      return results;
    }

    function findDiffPairs(absDiff, bankHigher) {
      var candidates = [];
      (state.instances || []).forEach(function(b) {
        if (reconcileDeletedIds[b.id]) return;
        var paid = isPaid(b);

        // Same directional logic as singles
        var eligible = false;
        if (bankHigher) {
          eligible = (!paid && b.direction === 'IN') || (paid && b.direction === 'OUT');
        } else {
          eligible = (!paid && b.direction === 'OUT') || (paid && b.direction === 'IN');
        }
        if (eligible) candidates.push(b);
      });

      var results = [];
      // Cap to avoid performance issues ‚Äî only check if reasonable number of candidates
      if (candidates.length > 100) return results;

      for (var i = 0; i < candidates.length; i++) {
        for (var j = i + 1; j < candidates.length; j++) {
          var sum = effectiveAmount(candidates[i]) + effectiveAmount(candidates[j]);
          if (Math.abs(sum - absDiff) < 0.01) {
            results.push({
              type: 'pair',
              explanation: 'These two entries total the difference',
              items: [candidates[i], candidates[j]]
            });
          }
        }
        // Cap results
        if (results.length >= 10) break;
      }
      return results;
    }

    function renderDiffMatch(match) {
      var html = '<div class="reconcile-diff-match">';
      html += '<div class="match-explanation">' + esc(match.explanation) + '</div>';
      match.items.forEach(function(b) {
        var isIn = b.direction === 'IN';
        var sign = isIn ? '+' : '-';
        var dateStr = b.due_date ? fmtDateShort(b.due_date.slice(0, 10)) : 'No date';
        var paidTag = isPaid(b) ? ' (paid)' : ' (unpaid)';
        html += '<div class="match-entry">';
        html += '<div>';
        html += '<div class="entry-name">' + esc(b.name) + '</div>';
        html += '<div class="entry-meta">' + dateStr + paidTag + '</div>';
        html += '</div>';
        html += '<span class="entry-amt" style="color:' + (isIn ? 'var(--accent-green)' : 'var(--accent-red)') + '">' + sign + money(effectiveAmount(b)) + '</span>';
        html += '</div>';
      });
      html += '</div>';
      return html;
    }

    function showReconcilePairs() {
      var container = $('reconcilePairsContainer');
      if (container) container.style.display = 'block';
      // Hide the toggle button
      var btn = container ? container.previousElementSibling : null;
      if (btn && btn.classList.contains('reconcile-pairs-toggle')) btn.style.display = 'none';
    }

    function keepBothDuplicates(groupId) {
      var el = $('reconcileGroup' + groupId);
      if (el) {
        el.style.opacity = '0.4';
        el.style.pointerEvents = 'none';
        // Replace actions with "Kept" label
        var actions = el.querySelector('.reconcile-match-actions');
        if (actions) actions.innerHTML = '<span style="color:var(--text-muted);font-size:12px;padding:4px 0;">‚úì Keeping both</span>';
      }
    }

    function deleteReconcileDup(groupId, itemIdx) {
      var group = reconcileDuplicates.filter(function(g) { return g.groupId === groupId; })[0];
      if (!group) return;
      var bill = group.items[itemIdx];
      if (!bill) return;

      if (!confirm('Delete "' + bill.name + '" (' + money(effectiveAmount(bill)) + ')?')) return;

      var hasRule = !!bill.bill_rule_id;
      var endpoint = hasRule ? 'api_deleteBillInstance' : 'api_deleteManualBill';

      api(endpoint, { instanceId: bill.id })
        .then(function() {
          reconcileDeletedIds[bill.id] = true;
          // Remove from state.instances too
          state.instances = (state.instances || []).filter(function(b) { return b.id !== bill.id; });
          // Re-render everything
          render();
          renderReconcile();
        })
        .catch(function(e) {
          alert('Error deleting: ' + e.message);
        });
    }
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('modal-bg')) {
        closeDayModal();
        $('editChoiceModal').classList.remove('open');
        selectedBill = null;
        closeBillEditModal();
        closeRuleModal();
        closeFilterModal();
        closeBalanceSheet();
        closeReconcile();
      }
    });

    // ========== INIT ==========
    function init() {
      setStat(1, 'Page loaded: OK', true);

      if (typeof window.supabase === 'undefined') {
        setStat(2, 'Supabase CDN: FAILED', false);
        showError('Supabase library failed to load.');
        return;
      }
      setStat(2, 'Supabase CDN: OK', true);

      try {
        sb = window.supabase.createClient(SUPA_URL, SUPA_KEY);
        setStat(3, 'Supabase client: OK', true);
      } catch (e) {
        setStat(3, 'Supabase client: FAILED - ' + e.message, false);
        return;
      }

      setStat(4, 'Auth check: checking...', null);

      sb.auth.getSession()
        .then(function(res) {
          if (res.error) {
            setStat(4, 'Auth check: error - ' + res.error.message, false);
            showAuth();
            return;
          }

          if (res.data && res.data.session) {
            session = res.data.session;
            setStat(4, 'Auth check: OK', true);
            showMain();
            loadBoot();
          } else {
            setStat(4, 'Auth check: no session', true);
            showAuth();
          }
        })
        .catch(function(e) {
          setStat(4, 'Auth check: exception - ' + e.message, false);
          showAuth();
        });

      sb.auth.onAuthStateChange(function(event, sess) {
        if (event === 'SIGNED_IN' && sess) {
          session = sess;
          showMain();
          loadBoot();
        } else if (event === 'SIGNED_OUT') {
          session = null;
          showAuth();
        }
      });
    }

    // ========== SCREENSHOT IMPORT ==========
    var pendingImportTransactions = [];
    
    function openImportModal() {
      // Reset state
      pendingImportTransactions = [];
      $('importStep1').style.display = 'block';
      $('importStep2').style.display = 'none';
      $('importStep3').style.display = 'none';
      $('importConfirmBtn').style.display = 'none';
      $('importDoneBtn').style.display = 'none';
      $('importPreviewImg').innerHTML = '';
      $('importError').textContent = '';
      $('importLoading').style.display = 'none';
      $('importFileInput').value = '';
      
      $('importModal').classList.add('open');
    }
    
    function closeImportModal() {
      $('importModal').classList.remove('open');
    }
    
    function handleImportFile(event) {
      var file = event.target.files[0];
      if (!file) return;
      
      // Validate file type
      if (!file.type.startsWith('image/')) {
        $('importError').textContent = 'Please select an image file.';
        return;
      }
      
      // Show preview
      var reader = new FileReader();
      reader.onload = function(e) {
        var base64Full = e.target.result;
        var base64Data = base64Full.split(',')[1]; // Remove data:image/...;base64, prefix
        var mediaType = file.type;
        
        // Show preview image
        $('importPreviewImg').innerHTML = '<img src="' + base64Full + '" alt="Preview">';
        $('importError').textContent = '';
        $('importLoading').style.display = 'flex';
        
        // Call API to analyze image
        analyzeScreenshot(base64Data, mediaType);
      };
      reader.readAsDataURL(file);
    }
    
    function analyzeScreenshot(base64Data, mediaType) {
      api('api_importFromScreenshot', {
        imageBase64: base64Data,
        imageMediaType: mediaType,
        targetMonth: state.month
      })
        .then(function(result) {
          $('importLoading').style.display = 'none';
          
          if (result.warning) {
            $('importError').textContent = result.warning;
          }
          
          if (!result.transactions || result.transactions.length === 0) {
            $('importError').textContent = 'No transactions found in the image. Try a clearer screenshot.';
            return;
          }
          
          // Store transactions and show step 2
          pendingImportTransactions = result.transactions.map(function(t, i) {
            return {
              id: i,
              selected: true,
              date: t.date,
              name: t.name,
              amount: t.amount,
              direction: t.direction
            };
          });
          
          showImportReview();
        })
        .catch(function(err) {
          $('importLoading').style.display = 'none';
          $('importError').textContent = 'Error: ' + err.message;
        });
    }
    
    function showImportReview() {
      $('importStep1').style.display = 'none';
      $('importStep2').style.display = 'block';
      $('importConfirmBtn').style.display = 'inline-block';
      
      renderImportTransactions();
    }
    
    function renderImportTransactions() {
      var html = '';
      var totalIn = 0;
      var totalOut = 0;
      var selectedCount = 0;
      
      pendingImportTransactions.forEach(function(t) {
        var amtCls = t.direction === 'IN' ? 'in' : 'out';
        var sign = t.direction === 'IN' ? '+' : '-';
        var checked = t.selected ? 'checked' : '';
        
        if (t.selected) {
          selectedCount++;
          if (t.direction === 'IN') {
            totalIn += t.amount;
          } else {
            totalOut += t.amount;
          }
        }
        
        html += '<div class="import-transaction">';
        html += '<input type="checkbox" ' + checked + ' onchange="toggleImportTransaction(' + t.id + ', this.checked)">';
        html += '<div class="import-transaction-info">';
        html += '<div class="import-transaction-name">' + esc(t.name) + '</div>';
        html += '<div class="import-transaction-date">' + t.date + '</div>';
        html += '</div>';
        html += '<span class="import-transaction-amount ' + amtCls + '">' + sign + '$' + t.amount.toFixed(2) + '</span>';
        html += '</div>';
      });
      
      $('importTransactionsList').innerHTML = html;
      
      // Update summary
      var summaryHtml = selectedCount + ' selected: ';
      summaryHtml += '<span style="color:var(--accent-green)">+$' + totalIn.toFixed(2) + ' IN</span>';
      summaryHtml += ' / ';
      summaryHtml += '<span style="color:var(--accent-red)">-$' + totalOut.toFixed(2) + ' OUT</span>';
      $('importSummary').innerHTML = summaryHtml;
    }
    
    function toggleImportTransaction(id, selected) {
      pendingImportTransactions.forEach(function(t) {
        if (t.id === id) t.selected = selected;
      });
      renderImportTransactions();
    }
    
    function confirmImport() {
      var toImport = pendingImportTransactions.filter(function(t) { return t.selected; });
      
      if (toImport.length === 0) {
        alert('No transactions selected.');
        return;
      }
      
      $('importConfirmBtn').style.display = 'none';
      $('importLoading').style.display = 'flex';
      $('importLoading').querySelector('span').textContent = 'Importing...';
      $('importStep2').appendChild($('importLoading'));
      
      // Build batch payload
      var rows = toImport.map(function(t) {
        return {
          dueDate: t.date,
          name: t.name,
          amount: t.amount,
          direction: t.direction,
          paid: false
        };
      });
      
      // Single batch API call
      api('api_batchCreateManualBills', {
        accountId: state.accountId,
        billMonth: state.month,
        rows: rows
      })
        .then(function(res) {
          $('importLoading').style.display = 'none';
          $('importStep2').style.display = 'none';
          $('importStep3').style.display = 'block';
          $('importDoneBtn').style.display = 'inline-block';
          $('importedCount').textContent = res.createdCount || toImport.length;
          
          // Refresh the calendar
          refreshAfterEdit();
        })
        .catch(function(err) {
          $('importLoading').style.display = 'none';
          $('importConfirmBtn').style.display = 'inline-block';
          alert('Import failed: ' + err.message);
        });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }

    // Register Service Worker for PWA
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('sw.js')
          .then(function(registration) {
            console.log('FlowCal SW registered:', registration.scope);
          })
          .catch(function(error) {
            console.log('FlowCal SW registration failed:', error);
          });
      });
    }
  </script>

</body>
</html>
